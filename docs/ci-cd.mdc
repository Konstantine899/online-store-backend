# CI/CD Pipeline Documentation

## –û–±–∑–æ—Ä

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GitHub Actions –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–µ–ø–ª–æ—è.

---

## Pipeline Structure

### Workflow: `ci.yml`

–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞:
- Pull Requests –≤ –≤–µ—Ç–∫–∏ `main`, `develop`
- Push –≤ –≤–µ—Ç–∫–∏ `main`, `develop`

---

## Jobs (—ç—Ç–∞–ø—ã –ø–∞–π–ø–ª–∞–π–Ω–∞)

### 1. **Lint** (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º ESLint.

**–ö–æ–º–∞–Ω–¥–∞:** `npm run lint:ts`

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `any` —Ç–∏–ø–æ–≤ (strict mode)
- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- –ü—Ä–∞–≤–∏–ª–∞ –∫–æ–¥—Å—Ç–∞–π–ª–∞ (import order, naming conventions)
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏ (no-explicit-any, no-unused-vars)

**–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
```bash
npm run lint:ts
npm run lint:ts:fix  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~30 —Å–µ–∫—É–Ω–¥

---

### 2. **Build** (—Å–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ TypeScript –∫–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫.

**–ö–æ–º–∞–Ω–¥–∞:** `npm run build`

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏ TypeScript
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—É—Ç–µ–π –∏–º–ø–æ—Ä—Ç–æ–≤
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è tsconfig.json

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** `dist/` (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ 7 –¥–Ω–µ–π)

**–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
```bash
npm run build
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~45 —Å–µ–∫—É–Ω–¥

---

### 3. **Test Unit** (—é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã)

**–¶–µ–ª—å:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ unit-—Ç–µ—Å—Ç—ã –±–µ–∑ –ë–î.

**–ö–æ–º–∞–Ω–¥–∞:** `npm run test:unit`

**–ü–æ–∫—Ä—ã–≤–∞–µ—Ç:**
- Guards (BruteforceGuard, RoleGuard, AuthGuard)
- Strategies (JwtStrategy)
- Middleware (CorrelationIdMiddleware)
- Validators (IsValidName, IsPasswordStrong, etc.)
- Services (–º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
- Utils (logger.factory, cookie-options)

**–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
```bash
npm run test:unit
npm run test:unit:watch  # Watch mode –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~20 —Å–µ–∫—É–Ω–¥

---

### 4. **Test Integration** (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã)

**–¶–µ–ª—å:** –ó–∞–ø—É—Å—Ç–∏—Ç—å E2E —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î.

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- MySQL 8.0 service
- Database migrations applied
- Database seeds applied

**–ö–æ–º–∞–Ω–¥–∞:** `npm run test:integration`

**–ü–æ–∫—Ä—ã–≤–∞–µ—Ç:**
- Auth flow (registration ‚Üí login ‚Üí refresh ‚Üí logout)
- RBAC (role-based access control)
- Security headers (CORS, Helmet, CSP)
- Input validation
- Brute-force protection

**–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å MySQL (Docker)
docker run -d --name mysql-test \
  -e MYSQL_ROOT_PASSWORD=test_root_password \
  -e MYSQL_DATABASE=online_store_test \
  -e MYSQL_USER=test_user \
  -e MYSQL_PASSWORD=test_password \
  -p 3306:3306 mysql:8.0

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å–∏–¥—ã
npm run db:migrate:test
npm run db:seed:test

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
npm run test:integration

# 4. –û—á–∏—Å—Ç–∫–∞
docker stop mysql-test && docker rm mysql-test
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~1 –º–∏–Ω—É—Ç–∞ 30 —Å–µ–∫—É–Ω–¥

---

### 5. **Coverage** (–ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ —Ç–µ—Å—Ç–∞–º–∏)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ coverage ‚â•70% (global threshold).

**–ö–æ–º–∞–Ω–¥–∞:** `npm run test:cov`

**Thresholds (–Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ jest.config.js):**
```javascript
coverageThreshold: {
  global: {
    branches: 70,
    functions: 70,
    lines: 70,
    statements: 70
  }
}
```

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–¥—É–ª–∏ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å ‚â•80%):**
- BruteforceGuard: 95%+ ‚úÖ
- RoleGuard: 100% ‚úÖ
- JwtStrategy: 92%+ ‚úÖ
- CorrelationIdMiddleware: 100% ‚úÖ
- AuthService: 97%+ ‚úÖ
- TokenService: 96%+ ‚úÖ

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Coverage report HTML (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ 30 –¥–Ω–µ–π)

**–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
```bash
npm run test:cov
npm run test:cov:open  # –û—Ç–∫—Ä—ã—Ç—å HTML –æ—Ç—á—ë—Ç
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~2 –º–∏–Ω—É—Ç—ã

---

### 6. **Migration Check** (–ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π)

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –æ—Ç–∫–∞—Ç–∏—Ç—å.

**–ö–æ–º–∞–Ω–¥—ã:**
1. `npm run db:migrate:test` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
2. `npm run db:migrate:undo:test` - –æ—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
3. `npm run db:migrate:test` - –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- SQL —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- `up` –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- `down` –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç (rollback)
- –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤/–¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- Foreign keys –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

**–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
```bash
npm run db:migrate:test
npm run db:migrate:status:test
npm run db:migrate:undo:test
npm run db:migrate:test
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~30 —Å–µ–∫—É–Ω–¥

---

### 7. **All Checks Passed** (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)

**–¶–µ–ª—å:** –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö jobs.

**–õ–æ–≥–∏–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ jobs –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ
- –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω failed ‚Üí job failed
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ required status check –¥–ª—è merge

**–í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** (`if: always()`), –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ jobs —É–ø–∞–ª–∏.

---

## Environment Variables

### –°–µ–∫—Ä–µ—Ç—ã –¥–ª—è CI (GitHub Secrets):

**–ù–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞** - –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–µ–∫—Ä–µ—Ç—ã hardcoded –≤ workflow.

–í production CI –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è:
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASS`
- `JWT_ACCESS_SECRET`, `JWT_REFRESH_SECRET`
- `COOKIE_PARSER_SECRET_KEY`
- `ALLOWED_ORIGINS` (–¥–ª—è CORS)

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å–µ–∫—Ä–µ—Ç—ã:

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ CI (hardcoded):
```yaml
JWT_ACCESS_SECRET: test-secret-key-for-ci-pipeline-access-token-32chars
JWT_REFRESH_SECRET: test-secret-key-for-ci-pipeline-refresh-token-32chars
COOKIE_PARSER_SECRET_KEY: test-cookie-parser-secret-key-for-ci-pipeline-min-32-chars
```

**–í–∞–∂–Ω–æ:** –≠—Ç–∏ —Å–µ–∫—Ä–µ—Ç—ã –¢–û–õ–¨–ö–û –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ production!

---

## Branch Protection Rules

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è `main` –≤–µ—Ç–∫–∏:

**Require pull request reviews:**
- ‚úÖ Minimum 1 reviewer approval
- ‚úÖ Dismiss stale reviews when new commits pushed

**Require status checks:**
- ‚úÖ `lint` - –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
- ‚úÖ `build` - –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
- ‚úÖ `test-unit` - –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
- ‚úÖ `test-integration` - –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
- ‚úÖ `coverage` - –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
- ‚úÖ `migration-check` - –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
- ‚úÖ `all-checks-passed` - –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏

**Other settings:**
- ‚úÖ Require branches to be up to date before merging
- ‚úÖ Require linear history (squash merge preferred)
- ‚ùå Allow force pushes (–∑–∞–ø—Ä–µ—â–µ–Ω–æ)
- ‚ùå Allow deletions (–∑–∞–ø—Ä–µ—â–µ–Ω–æ)

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Lint failed

**–°–∏–º–ø—Ç–æ–º:**
```
ESLint found 5 errors
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏
npm run lint:ts

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
npm run lint:ts:fix

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞
npm run lint:ts
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Build failed

**–°–∏–º–ø—Ç–æ–º:**
```
TS2304: Cannot find name 'SomeType'
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
npm run build

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å tsconfig.json
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã (@app/* –∞–ª–∏–∞—Å—ã)
# –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ TypeScript
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Unit tests failed

**–°–∏–º–ø—Ç–æ–º:**
```
FAIL tests/unit/guards/role.guard.unit.test.ts
‚óè RoleGuard ‚Ä∫ should allow access for valid role
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
npm run test:unit

# Watch mode –¥–ª—è –¥–µ–±–∞–≥–∞
npm run test:unit:watch

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∫–∏ –∏ —Ç–∏–ø—ã
# –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Integration tests failed

**–°–∏–º–ø—Ç–æ–º:**
```
MySQL connection refused
ECONNREFUSED 127.0.0.1:3306
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ MySQL service –∑–∞–ø—É—â–µ–Ω –≤ CI
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health check settings
3. –õ–æ–∫–∞–ª—å–Ω–æ:
```bash
# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ MySQL –∑–∞–ø—É—â–µ–Ω
docker ps | grep mysql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .test.env –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
cat .test.env

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
npm run db:migrate:test

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
npm run test:integration
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Coverage below threshold

**–°–∏–º–ø—Ç–æ–º:**
```
Jest: "global" coverage threshold for branches (70%) not met: 65.5%
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
npm run test:cov

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å HTML –æ—Ç—á—ë—Ç
npm run test:cov:open

# –ù–∞–π—Ç–∏ –Ω–µ–ø–æ–∫—Ä—ã—Ç—ã–µ –≤–µ—Ç–∫–∏ (branches)
# –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞
npm run test:cov
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Migrations failed

**–°–∏–º–ø—Ç–æ–º:**
```
ERROR: Table 'user' already exists
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
npm run db:migrate:status:test

# –û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ
npm run db:migrate:undo:all:test

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–Ω–æ–≤–∞
npm run db:migrate:test

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ rollback —Ä–∞–±–æ—Ç–∞–µ—Ç
npm run db:migrate:undo:test
npm run db:migrate:test
```

---

## Performance Optimization

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```yaml
- uses: actions/setup-node@v4
  with:
    cache: 'npm'  # ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ node_modules
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ~2 –º–∏–Ω—É—Ç—ã —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ

---

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ jobs

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**
```
lint (30s)
  ‚îú‚îÄ‚îÄ build (45s) [parallel]
  ‚îú‚îÄ‚îÄ test-unit (20s) [parallel]
  ‚îî‚îÄ‚îÄ migration-check (30s) [parallel]

test-integration (90s) [after test-unit]

coverage (120s) [after test-unit + test-integration]

all-checks-passed [after all]
```

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~3-4 –º–∏–Ω—É—Ç—ã (–≤–º–µ—Å—Ç–æ 6+ –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)

---

### MySQL health check

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```yaml
services:
  mysql:
    options: >-
      --health-cmd="mysqladmin ping"
      --health-interval=10s
      --health-timeout=5s
      --health-retries=3
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** MySQL –≥–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –¥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤

---

## –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è CI

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–æ–∫ (–∫–∞–∫ –≤ CI):

```bash
# 1. Lint
npm run lint:ts

# 2. Build
npm run build

# 3. Unit tests
npm run test:unit

# 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î –¥–ª—è integration tests
docker run -d --name mysql-ci-test \
  -e MYSQL_ROOT_PASSWORD=test_root_password \
  -e MYSQL_DATABASE=online_store_test \
  -e MYSQL_USER=test_user \
  -e MYSQL_PASSWORD=test_password \
  -p 3306:3306 mysql:8.0

# –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–æ–∫–∞ MySQL —Å—Ç–∞—Ä—Ç—É–µ—Ç
sleep 10

# 5. –ú–∏–≥—Ä–∞—Ü–∏–∏
npm run db:migrate:test

# 6. –°–∏–¥—ã
npm run db:seed:test

# 7. Integration tests
npm run test:integration

# 8. Coverage
npm run test:cov

# 9. –û—á–∏—Å—Ç–∫–∞
docker stop mysql-ci-test && docker rm mysql-ci-test
```

**–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã:**
```bash
#!/bin/bash
# scripts/ci-local.sh
set -e

echo "üîç Running lint..."
npm run lint:ts

echo "üèóÔ∏è Building..."
npm run build

echo "‚úÖ Running unit tests..."
npm run test:unit

echo "üê≥ Starting MySQL..."
docker run -d --name mysql-ci-test \
  -e MYSQL_ROOT_PASSWORD=test_root_password \
  -e MYSQL_DATABASE=online_store_test \
  -e MYSQL_USER=test_user \
  -e MYSQL_PASSWORD=test_password \
  -p 3306:3306 mysql:8.0

echo "‚è≥ Waiting for MySQL..."
sleep 15

echo "üì¶ Running migrations..."
npm run db:migrate:test

echo "üå± Seeding database..."
npm run db:seed:test

echo "üß™ Running integration tests..."
npm run test:integration

echo "üìä Generating coverage..."
npm run test:cov

echo "üßπ Cleanup..."
docker stop mysql-ci-test && docker rm mysql-ci-test

echo "üéâ All CI checks passed locally!"
```

---

## –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:

| Job | Target | Current |
|-----|--------|---------|
| Lint | < 1 min | ~30s ‚úÖ |
| Build | < 1 min | ~45s ‚úÖ |
| Unit Tests | < 1 min | ~20s ‚úÖ |
| Integration Tests | < 2 min | ~90s ‚úÖ |
| Coverage | < 3 min | ~120s ‚úÖ |
| Migration Check | < 1 min | ~30s ‚úÖ |
| **Total Pipeline** | **< 5 min** | **~4 min** ‚úÖ |

---

## Coverage Thresholds

### Global (–º–∏–Ω–∏–º—É–º –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞):

```javascript
global: {
  branches: 70%,
  functions: 70%,
  lines: 70%,
  statements: 70%
}
```

**–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞:** –ï—Å–ª–∏ coverage –ø–∞–¥–∞–µ—Ç –Ω–∏–∂–µ 70% ‚Üí CI failed ‚Üí merge –∑–∞–ø—Ä–µ—â—ë–Ω

### Critical Modules (–æ–∂–∏–¥–∞–µ—Ç—Å—è ‚â•80%):

- `BruteforceGuard`: 95%+ ‚úÖ
- `RoleGuard`: 100% ‚úÖ
- `JwtStrategy`: 92%+ ‚úÖ
- `CorrelationIdMiddleware`: 100% ‚úÖ
- `AuthService`: 97%+ ‚úÖ
- `TokenService`: 96%+ ‚úÖ
- `UserService`: 89%+ ‚úÖ

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** Coverage –æ—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–∞ 30 –¥–Ω–µ–π

---

## Pull Request Process

### 1. –°–æ–∑–¥–∞–Ω–∏–µ PR

```bash
# –°–æ–∑–¥–∞—Ç—å feature –≤–µ—Ç–∫—É
git checkout -b feature/auth/add-2fa

# –í–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
# ...

# –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å
git add .
git commit -m "feat(auth): add two-factor authentication"

# Push
git push origin feature/auth/add-2fa

# –°–æ–∑–¥–∞—Ç—å PR –≤ GitHub UI
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è PR –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è CI:

```
‚úì lint             (30s)
‚úì build            (45s)
‚úì test-unit        (20s)
‚úì test-integration (90s)
‚úì coverage         (120s)
‚úì migration-check  (30s)
‚úì all-checks-passed
```

### 3. Code Review

**Reviewers:** –ú–∏–Ω–∏–º—É–º 1 approver

**Checklist:**
- [ ] –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç code-style –ø—Ä–∞–≤–∏–ª–∞–º
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- [ ] Coverage –Ω–µ –ø—Ä–æ—Å–µ–ª (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–æ–¥—É–ª–µ–π)
- [ ] Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π `down`
- [ ] –ù–µ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ PII
- [ ] –†—É—Å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### 4. Merge

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** Squash and merge (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –í—Å–µ CI checks passed
- ‚úÖ –ú–∏–Ω–∏–º—É–º 1 approval
- ‚úÖ Branch up-to-date —Å main
- ‚úÖ No merge conflicts

**–ü–æ—Å–ª–µ merge:**
- Feature –≤–µ—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è
- CI –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ main
- Coverage –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

---

## Deployment (–±—É–¥—É—â–µ–µ)

### Staging

**–¢—Ä–∏–≥–≥–µ—Ä:** Push –≤ `develop` –≤–µ—Ç–∫—É

**–ü–ª–∞–Ω (TODO):**
```yaml
deploy-staging:
  if: github.ref == 'refs/heads/develop'
  needs: [all-checks-passed]
  steps:
    - Deploy to staging environment
    - Run smoke tests
    - Notify team (Slack/Telegram)
```

### Production

**–¢—Ä–∏–≥–≥–µ—Ä:** Push tag `v*.*.*`

**–ü–ª–∞–Ω (TODO):**
```yaml
deploy-production:
  if: startsWith(github.ref, 'refs/tags/v')
  needs: [all-checks-passed]
  steps:
    - Deploy to production
    - Run smoke tests
    - Create GitHub Release
    - Notify team
```

---

## Notifications

### Failed CI

**–¢–µ–∫—É—â–µ–µ:** GitHub UI + email notifications

**–ë—É–¥—É—â–µ–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- Slack webhook –¥–ª—è –∫–æ–º–∞–Ω–¥—ã
- Telegram bot notifications
- Discord integration

---

## Maintenance

### –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∑–∞–¥–∞—á–∏:

**–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å coverage trends (–Ω–µ –ø–∞–¥–∞–µ—Ç –ª–∏)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è pipeline (–Ω–µ —Ä–∞—Å—Ç—ë—Ç –ª–∏)
- –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ artifacts

**–ï–∂–µ–º–µ—Å—è—á–Ω–æ:**
- –û–±–Ω–æ–≤–∏—Ç—å GitHub Actions versions (dependabot)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å MySQL image version
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–ü—Ä–∏ —Ä–µ–ª–∏–∑–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ checks green
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ staging
- Backup –ë–î –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ production

---

## Best Practices

### ‚úÖ DO:

- –ó–∞–ø—É—Å–∫–∞—Ç—å `npm run lint:ts` –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º commit
- –ó–∞–ø—É—Å–∫–∞—Ç—å `npm run test:unit` –ª–æ–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥ push
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `npm ci` –≤ CI (–Ω–µ `npm install`)
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å node_modules –≤ CI
- –î–µ—Ä–∂–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω –±—ã—Å—Ç—Ä—ã–º (< 5 –º–∏–Ω—É—Ç)

### ‚ùå DON'T:

- –ù–µ –ø—É—à–∏—Ç—å –±–µ–∑ lint –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ù–µ –º–µ—Ä–¥–∂–∏—Ç—å —Å failing tests
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `--no-verify` –≤ git hooks
- –ù–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å coverage –ø–∞–¥–µ–Ω–∏–µ
- –ù–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å production —Å–µ–∫—Ä–µ—Ç—ã –≤ workflow
- –ù–µ skip –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–ª—è "—Å—Ä–æ—á–Ω—ã—Ö" —Ñ–∏–∫—Å–æ–≤

---

## Contacts

**–í–æ–ø—Ä–æ—Å—ã –ø–æ CI/CD:**
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `docs/ci-cd.mdc`
- GitHub Actions docs: https://docs.github.com/actions
- Jest coverage: https://jestjs.io/docs/configuration#coveragethreshold

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –°–æ–∑–¥–∞—Ç—å issue —Å —Ç–µ–≥–æ–º `ci/cd`
- –û–ø–∏—Å–∞—Ç—å: —á—Ç–æ —É–ø–∞–ª–æ, –ª–æ–≥–∏, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

---

## Changelog

### 2025-10-07 - SEC-010
- ‚úÖ –°–æ–∑–¥–∞–Ω –æ—Å–Ω–æ–≤–Ω–æ–π CI –ø–∞–π–ø–ª–∞–π–Ω
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏: lint, build, test, coverage, migrations
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω MySQL service –¥–ª—è integration tests
- ‚úÖ Coverage thresholds: 70% global
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

---

**CI/CD pipeline –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ
