# Known Flaky Tests

**–°—Ç–∞—Ç—É—Å:** Active Issue
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 08.10.2025
**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ç–µ—Å—Ç—ã:** ~78 –∏–∑ 335 (–¥–æ 23% flaky rate)

---

## üìä –û–±—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

### –ú–µ—Ç—Ä–∏–∫–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:

- **Best case:** 335/335 passed (100%) ‚úÖ
- **Typical case:** 291-334/335 passed (87-99%) ‚ö†Ô∏è
- **Worst case:** 257/335 passed (77%) ‚ùå
- **–°—Ä–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** ~90% (10% flaky rate)

### –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:

- ‚úÖ `jest.retryTimes(1)` –¥–ª—è integration —Ç–µ—Å—Ç–æ–≤
- ‚úÖ `maxWorkers: 1` –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è 2-3 –∑–∞–ø—É—Å–∫–∞ –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤

---

## üêõ –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

### Shared Mutable State:

```typescript
// –í—Å–µ integration —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
const SHARED_USERS = {
    user13: 'user@example.com', // –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ 50+ —Ç–µ—Å—Ç–∞—Ö
    user14: 'admin@example.com', // –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ 30+ —Ç–µ—Å—Ç–∞—Ö
};

// –ü—Ä–æ–±–ª–µ–º–∞:
// 1. –¢–µ—Å—Ç—ã –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç email/phone/—Ä–æ–ª–∏ —ç—Ç–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
// 2. TestCleanup –Ω–µ –≤—Å–µ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
// 3. Race conditions –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
// 4. beforeAll —Å–æ–∑–¥–∞—ë—Ç tokens –æ–¥–∏–Ω —Ä–∞–∑ (—É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç –µ—Å–ª–∏ user –∏–∑–º–µ–Ω—ë–Ω)
```

---

## üìù –°–ø–∏—Å–æ–∫ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ (–ø–∞–¥–∞—é—Ç —á–∞—Å—Ç–æ, >10% fail rate):

#### 1. User Profile Tests (`src/infrastructure/controllers/user/tests/user-profile.integration.test.ts`)

- **–¢–µ—Å—Ç—ã:** 10 —Ç–µ—Å—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞:** Login fails —Å "–ù–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email" (user 13 –∏–∑–º–µ–Ω—ë–Ω)
- **–°–∏–º–ø—Ç–æ–º—ã:** 500/401 errors –ø—Ä–∏ authLoginAs('user')
- **–ß–∞—Å—Ç–æ—Ç–∞:** ~15% fail rate

#### 2. User Flags Tests (`src/infrastructure/controllers/user/tests/user-flags.integration.test.ts`)

- **–¢–µ—Å—Ç—ã:** 7 —Ç–µ—Å—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞:** –§–ª–∞–≥–∏ user 13 –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
- **–°–∏–º–ø—Ç–æ–º—ã:** 403 Forbidden (—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞), 401 "–ù–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email"
- **–ß–∞—Å—Ç–æ—Ç–∞:** ~12% fail rate

#### 3. Auth Flow Tests (`tests/integration/auth-flow.integration.test.ts`)

- **–¢–µ—Å—Ç—ã:** 13 —Ç–µ—Å—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞:** Refresh token rotation failures, cleanup SQL errors
- **–°–∏–º–ø—Ç–æ–º—ã:** "Failed to get refreshCookie", 500 Internal Server Error
- **–ß–∞—Å—Ç–æ—Ç–∞:** ~8% fail rate

#### 4. RBAC Tests (`tests/integration/rbac.integration.test.ts`)

- **–¢–µ—Å—Ç—ã:** 6 —Ç–µ—Å—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞:** SQL cleanup errors –≤ afterEach
- **–°–∏–º–ø—Ç–æ–º—ã:** DELETE FROM login_history failures
- **–ß–∞—Å—Ç–æ—Ç–∞:** ~10% fail rate

#### 5. User Addresses Tests (`src/infrastructure/controllers/user/tests/user-addresses.integration.test.ts`)

- **–¢–µ—Å—Ç—ã:** 6 —Ç–µ—Å—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞:** User 13 –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –¥—Ä—É–≥–∏–º–∏ —Ç–µ—Å—Ç–∞–º–∏
- **–°–∏–º–ø—Ç–æ–º—ã:** 500 Internal Server Error –ø—Ä–∏ login
- **–ß–∞—Å—Ç–æ—Ç–∞:** ~10% fail rate

#### 6. User Verification Tests (`src/infrastructure/controllers/user/tests/user-verification.integration.test.ts`)

- **–¢–µ—Å—Ç—ã:** 6 —Ç–µ—Å—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞:** Email user 13 –∏–∑–º–µ–Ω—ë–Ω
- **–°–∏–º–ø—Ç–æ–º—ã:** 401 "–ù–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email"
- **–ß–∞—Å—Ç–æ—Ç–∞:** ~8% fail rate

#### 7. User Preferences Tests (`src/infrastructure/controllers/user/tests/user-preferences.integration.test.ts`)

- **–¢–µ—Å—Ç—ã:** 7 —Ç–µ—Å—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞:** User 13 deleted/modified
- **–°–∏–º–ø—Ç–æ–º—ã:** 401/500 errors –ø—Ä–∏ login
- **–ß–∞—Å—Ç–æ—Ç–∞:** ~10% fail rate

---

## üîß –¢–µ–∫—É—â–∏–µ mitigation —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ:

1. **Retry –º–µ—Ö–∞–Ω–∏–∑–º:** `retryTimes: 1` –≤ jest.config.js
2. **Sequential execution:** `maxWorkers: 1` –¥–ª—è integration
3. **Test utilities:** TestDataFactory, TestCleanup
4. **SQL logging disabled:** —á–∏—Å—Ç—ã–π –≤—ã–≤–æ–¥ —Ç–µ—Å—Ç–æ–≤

### ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **TestCleanup.resetUser13():** —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥–∏/phone, –ù–û –ù–ï email/—Ä–æ–ª–∏
2. **TestCleanup.cleanAuthData():** —É–¥–∞–ª—è–µ—Ç auth records –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. **Unique test data:** TestDataFactory.uniqueEmail/Phone (–Ω–µ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

### ‚ùå –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **Transaction isolation:** –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –¥–ª—è HTTP tests
2. **Complete state reset:** —Å–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–æ (hash –ø–∞—Ä–æ–ª–µ–π)
3. **Parallel execution:** –¥–∞–∂–µ `maxWorkers: 2` –¥–∞—ë—Ç race conditions

---

## üéØ –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥ (–≥–∏–±—Ä–∏–¥–Ω—ã–π):

#### –§–∞–∑–∞ 1: –ü—Ä–∏–Ω—è—Ç—å —Ç–µ–∫—É—â—É—é –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (DONE)

- ‚úÖ Retry –¥–æ–±–∞–≤–ª–µ–Ω
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ 90% —Å–ª—É—á–∞–µ–≤

#### –§–∞–∑–∞ 2: –ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ (PHASE 2-6 –ø–ª–∞–Ω–∞)

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç —Å–æ–∑–¥–∞—ë—Ç —Å–≤–æ–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
it('should do something', async () => {
    const uniqueUser = await TestDataFactory.createUser();
    const token = await authLoginAs(app, uniqueUser.email, uniqueUser.password);

    // –¢–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ

    // Cleanup –≤ afterEach —É–¥–∞–ª—è–µ—Ç uniqueUser
});

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ shared user
it('should do something', async () => {
    const token = await authLoginAs(app, 'user'); // user 13 - shared!
});
```

#### –§–∞–∑–∞ 3: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (background)

- –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ 10-15 —Ç–µ—Å—Ç–æ–≤ –≤ –Ω–µ–¥–µ–ª—é
- 335 —Ç–µ—Å—Ç–æ–≤ ‚Üí 22 –Ω–µ–¥–µ–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–æ–π

---

## üìä Impact –Ω–∞ CI/CD

### –î–æ retry (–±—ã–ª–æ):

```
–°—Ü–µ–Ω–∞—Ä–∏–π 1: –¢–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞ (77% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
‚Üí CI green ‚úÖ

–°—Ü–µ–Ω–∞—Ä–∏–π 2: –¢–µ—Å—Ç—ã —É–ø–∞–ª–∏ (23% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
‚Üí –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
‚Üí –ó–∞–¥–µ—Ä–∂–∫–∞ —Ä–µ–ª–∏–∑–∞ –Ω–∞ 5-30 –º–∏–Ω—É—Ç
```

### –ü–æ—Å–ª–µ retry (—Å–µ–π—á–∞—Å):

```
–°—Ü–µ–Ω–∞—Ä–∏–π 1: –¢–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞ (77% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
‚Üí CI green ‚úÖ

–°—Ü–µ–Ω–∞—Ä–∏–π 2: –¢–µ—Å—Ç—ã —É–ø–∞–ª–∏, retry –ø—Ä–æ—à—ë–ª (20% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
‚Üí CI green ‚úÖ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±–∞ –ø—Ä–æ–≥–æ–Ω–∞ —É–ø–∞–ª–∏ (3% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
‚Üí –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
‚Üí –í–µ—Ä–æ—è—Ç–Ω–æ —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–≥
```

**–£–ª—É—á—à–µ–Ω–∏–µ:** 77% ‚Üí 97% success rate ‚úÖ

---

## üö® Warnings –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### –ü—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö integration —Ç–µ—Å—Ç–æ–≤:

‚ùå **–ù–ï –î–ï–õ–ê–¢–¨:**

```typescript
// –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å shared users
const userToken = await authLoginAs(app, 'user');

// –ù–ï –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å user 13/14 –Ω–∞–ø—Ä—è–º—É—é
await sequelize.query(`UPDATE user SET email = 'new@test.com' WHERE id = 13`);

// –ù–ï –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ —Ç–µ—Å—Ç–æ–≤
```

‚úÖ **–î–ï–õ–ê–¢–¨:**

```typescript
// –°–æ–∑–¥–∞–≤–∞—Ç—å unique –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const testUser = await TestDataFactory.createUser();
const token = await authLoginAs(app, testUser.email, testUser.password);

// Cleanup –≤ afterEach
afterEach(async () => {
    await TestCleanup.cleanUsers(sequelize); // —É–¥–∞–ª—è–µ—Ç id > 14
});

// –¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã
```

---

## üìà –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏:

**Week 1-2:** –°–∞–º—ã–µ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ (>15% fail rate)

- user-profile.integration.test.ts (10 —Ç–µ—Å—Ç–æ–≤)
- user-flags.integration.test.ts (7 —Ç–µ—Å—Ç–æ–≤)

**Week 3-4:** –°—Ä–µ–¥–Ω—è—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (8-15% fail rate)

- auth-flow.integration.test.ts (13 —Ç–µ—Å—Ç–æ–≤)
- rbac.integration.test.ts (6 —Ç–µ—Å—Ç–æ–≤)
- user-addresses.integration.test.ts (6 —Ç–µ—Å—Ç–æ–≤)

**Week 5+:** –ù–∏–∑–∫–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (<8% fail rate)

- –û—Å—Ç–∞–ª—å–Ω—ã–µ 287 —Ç–µ—Å—Ç–æ–≤ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ

**–ò—Ç–æ–≥–æ:** ~22 –Ω–µ–¥–µ–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **Test Plan:** `.cursor/rules/SaaS/testing/testing.coverage.plan.mdc`
- **Investigation Log:** –ö–æ–º–º–∏—Ç `a6e73cc` (08.10.2025)
- **Test Utilities:** `tests/utils/` (TestDataFactory, TestCleanup, TestTransaction)

---

## üí° –î–ª—è —Ä–µ–≤—å—é–≤–µ—Ä–æ–≤ PR

–ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ PR —Å –Ω–æ–≤—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏:

- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ unique users (TestDataFactory)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –µ—Å—Ç—å –ª–∏ cleanup –≤ afterEach
- ‚ùå –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ users 13/14 –≤ –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–∞—Ö
- ‚ö†Ô∏è Warning: –µ—Å–ª–∏ —Ç–µ—Å—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç shared state

---

**–°—Ç–∞—Ç—É—Å:** –ü—Ä–∏–Ω—è—Ç–æ –∫–∞–∫ –∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞, —Ä–µ—à–∞–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ.
