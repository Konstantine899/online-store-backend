---
description: Правила безопасности
globs:
alwaysApply: true
---

# Безопасность

## Валидация и санитизация
- **Глобальная валидация**: `CustomValidationPipe` обрабатывает все DTO
- **Кастомные валидаторы**: `@IsSanitizedString`, `@IsValidName`, `@IsValidPhone`
- **Санитизация**: удаление HTML тегов, проверка на XSS паттерны
- **Сообщения об ошибках**: на русском языке, без раскрытия внутренней логики

## HTTP безопасность
- **Helmet**: `helmet({ crossOriginResourcePolicy: { policy: 'cross-origin' } })`
- **CORS**: строго необходимые origins из `ALLOWED_ORIGINS` env переменной
- **Cookie Parser**: с секретным ключом `COOKIE_PARSER_SECRET_KEY`
- **Content Security Policy**: рекомендуется для дополнительной защиты

## Аутентификация и авторизация
- **JWT**: короткий access токен (15m), долгий refresh токен (30d)
- **Refresh токен**: только в HttpOnly cookies, не в localStorage
- **Ротация токенов**: при каждом refresh генерируется новый refresh токен
- **Хэширование паролей**: `bcrypt` с достаточной сложностью
- **Роли**: `@Roles('ADMIN')`, `@UseGuards(AuthGuard, RoleGuard)`

## Rate Limiting и защита от атак
- **BruteforceGuard**: разные лимиты для разных endpoints
  - Login: 5 попыток в 15 минут
  - Refresh: 10 попыток в 5 минут  
  - Registration: 3 попытки в минуту
- **Общие лимиты**: 3 запроса/сек, 20 запросов/10сек, 100 запросов/мин
- **Логирование блокировок**: на уровне `warn` без PII

## Файловая безопасность
- **FileInterceptor**: с ограничениями размера и типов
- **Валидация файлов**: проверка MIME типов, размеров
- **Безопасное хранение**: вне БД, с проверкой доступа
- **Статические файлы**: через CDN, с кэшированием

## Конфигурация и секреты
- **Переменные окружения**: все секреты через env, валидация через Joi
- **Разделение окружений**: dev/stage/prod с разными ключами
- **Ротация ключей**: регулярная смена JWT секретов
- **Менеджер секретов**: для продакшена использовать внешние системы

## Логирование и мониторинг
- **Correlation ID**: для трекинга подозрительной активности
- **Маскирование PII**: токены, email, пароли в логах
- **Метрики безопасности**: количество блокировок, подозрительных запросов
- **Алерты**: на аномальную активность, множественные неудачные попытки

## Обработка ошибок
См. `errors-logging.mdc` — формат ошибок, логирование с correlation ID, без раскрытия деталей и с graceful degradation.

## Чек-лист безопасности для PR
- [ ] Валидация всех входных данных через DTO
- [ ] Санитизация строковых полей от XSS
- [ ] Проверка авторизации на защищённых endpoints
- [ ] Rate limiting для новых endpoints
- [ ] Логирование без PII
- [ ] Обработка ошибок без раскрытия внутренней логики
- [ ] Тестирование с некорректными данными
