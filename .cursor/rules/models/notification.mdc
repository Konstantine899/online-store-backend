# –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Notification System) - Ecommerce Edition

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ü–µ–ª—å
–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è ecommerce –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –±–∞–∑–æ–≤—ã–º–∏ email –∏ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏, —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –±—ã—Å—Ç—Ä—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞, —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏, —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è
- **Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –º–æ–±–∏–ª—å–Ω—ã–µ –∏ –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —à–∞–±–ª–æ–Ω—ã
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –≤–∫–ª/–≤—ã–∫–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `notifications`
```sql
CREATE TABLE notifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    type VARCHAR(10) NOT NULL CHECK (type IN ('email', 'push')),
    template_name VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    data JSONB,
    status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'sent', 'delivered', 'read', 'failed')),
    sent_at TIMESTAMP,
    read_at TIMESTAMP,
    failed_reason TEXT,
    is_read BOOLEAN DEFAULT false,
    is_archived BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### –¢–∞–±–ª–∏—Ü–∞ `notification_templates`
```sql
CREATE TABLE notification_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    type VARCHAR(10) NOT NULL CHECK (type IN ('email', 'push')),
    subject VARCHAR(255),
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    variables TEXT[],
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### –¢–∞–±–ª–∏—Ü–∞ `user_notification_settings`
```sql
CREATE TABLE user_notification_settings (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    email_enabled BOOLEAN DEFAULT true,
    push_enabled BOOLEAN DEFAULT true,
    order_updates BOOLEAN DEFAULT true,
    marketing BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id)
);
```

## –ú–æ–¥–µ–ª–∏ Sequelize

### Notification Model
```typescript
// src/domain/models/notification.model.ts
import { Model, DataType, Column, Table, BelongsTo, ForeignKey } from 'sequelize-typescript';
import { UserModel } from './user.model';

export enum NotificationType {
    EMAIL = 'email',
    PUSH = 'push'
}

export enum NotificationStatus {
    PENDING = 'pending',
    SENT = 'sent',
    DELIVERED = 'delivered',
    READ = 'read',
    FAILED = 'failed'
}

interface INotificationModel {
    id: number;
    userId: number;
    type: NotificationType;
    templateName: string;
    title: string;
    message: string;
    data?: any;
    status: NotificationStatus;
    sentAt?: Date;
    readAt?: Date;
    failedReason?: string;
    isRead: boolean;
    isArchived: boolean;
    user: UserModel;
    createdAt: Date;
}

interface INotificationCreationAttributes {
    userId: number;
    type: NotificationType;
    templateName: string;
    title: string;
    message: string;
    data?: any;
    status?: NotificationStatus;
    isRead?: boolean;
    isArchived?: boolean;
}

@Table({
    tableName: 'notifications',
    underscored: true,
    timestamps: true,
    createdAt: 'created_at',
    updatedAt: false,
    indexes: [
        { fields: ['user_id'], name: 'idx_notifications_user_id' },
        { fields: ['type'], name: 'idx_notifications_type' },
        { fields: ['status'], name: 'idx_notifications_status' },
        { fields: ['template_name'], name: 'idx_notifications_template_name' },
        { fields: ['is_read'], name: 'idx_notifications_is_read' },
        { fields: ['is_archived'], name: 'idx_notifications_is_archived' },
        { fields: ['created_at'], name: 'idx_notifications_created_at' },
        { fields: ['user_id', 'status'], name: 'idx_notifications_user_status' },
    ],
})
export class NotificationModel
    extends Model<NotificationModel, INotificationCreationAttributes>
    implements INotificationModel
{
    @Column({
        type: DataType.INTEGER,
        primaryKey: true,
        autoIncrement: true,
    })
    declare id: number;

    @ForeignKey(() => UserModel)
    @Column({
        type: DataType.INTEGER,
        allowNull: false,
        field: 'user_id',
    })
    declare userId: number;

    @Column({
        type: DataType.ENUM(...Object.values(NotificationType)),
        allowNull: false,
    })
    declare type: NotificationType;

    @Column({
        type: DataType.STRING(50),
        allowNull: false,
        field: 'template_name',
    })
    declare templateName: string;

    @Column({
        type: DataType.STRING(255),
        allowNull: false,
    })
    declare title: string;

    @Column({
        type: DataType.TEXT,
        allowNull: false,
    })
    declare message: string;

    @Column({
        type: DataType.JSONB,
        allowNull: true,
    })
    declare data: any;

    @Column({
        type: DataType.ENUM(...Object.values(NotificationStatus)),
        allowNull: false,
        defaultValue: NotificationStatus.PENDING,
    })
    declare status: NotificationStatus;

    @Column({
        type: DataType.DATE,
        allowNull: true,
        field: 'sent_at',
    })
    declare sentAt: Date;

    @Column({
        type: DataType.DATE,
        allowNull: true,
        field: 'read_at',
    })
    declare readAt: Date;

    @Column({
        type: DataType.TEXT,
        allowNull: true,
        field: 'failed_reason',
    })
    declare failedReason: string;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_read',
    })
    declare isRead: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_archived',
    })
    declare isArchived: boolean;

    @Column({
        type: DataType.DATE,
        allowNull: false,
        defaultValue: DataType.NOW,
        field: 'created_at',
    })
    declare createdAt: Date;

    @BelongsTo(() => UserModel)
    declare user: UserModel;

    // Getters –¥–ª—è —Ñ–ª–∞–≥–æ–≤
    get isReadNotification(): boolean {
        return this.isRead;
    }

    get isArchivedNotification(): boolean {
        return this.isArchived;
    }

    get notificationStatus(): string {
        if (this.isArchived) return 'archived';
        if (this.isRead) return 'read';
        return this.status;
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–ª–∞–≥–∞–º–∏
    async markAsRead(): Promise<void> {
        await this.update({ isRead: true, readAt: new Date() });
    }

    async markAsUnread(): Promise<void> {
        await this.update({ isRead: false, readAt: null });
    }

    async archiveNotification(): Promise<void> {
        await this.update({ isArchived: true });
    }

    async unarchiveNotification(): Promise<void> {
        await this.update({ isArchived: false });
    }

    // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–ª–∞–≥–∞–º–∏
    static async getReadNotifications(): Promise<NotificationModel[]> {
        return this.findAll({
            where: { isRead: true },
            order: [['createdAt', 'DESC']],
        });
    }

    static async getUnreadNotifications(): Promise<NotificationModel[]> {
        return this.findAll({
            where: { isRead: false },
            order: [['createdAt', 'DESC']],
        });
    }

    static async getArchivedNotifications(): Promise<NotificationModel[]> {
        return this.findAll({
            where: { isArchived: true },
            order: [['createdAt', 'DESC']],
        });
    }

    static async getNonArchivedNotifications(): Promise<NotificationModel[]> {
        return this.findAll({
            where: { isArchived: false },
            order: [['createdAt', 'DESC']],
        });
    }
}
```

### NotificationTemplate Model
```typescript
// src/domain/models/notification-template.model.ts
import { Model, DataType, Column, Table } from 'sequelize-typescript';
import { NotificationType } from './notification.model';

interface INotificationTemplateModel {
    id: number;
    name: string;
    type: NotificationType;
    subject?: string;
    title: string;
    message: string;
    variables: string[];
    isActive: boolean;
    createdAt: Date;
    updatedAt: Date;
}

interface INotificationTemplateCreationAttributes {
    name: string;
    type: NotificationType;
    subject?: string;
    title: string;
    message: string;
    variables?: string[];
    isActive?: boolean;
}

@Table({
    tableName: 'notification_templates',
    underscored: true,
    timestamps: true,
    indexes: [
        { fields: ['name'], name: 'idx_notification_templates_name', unique: true },
        { fields: ['type'], name: 'idx_notification_templates_type' },
        { fields: ['is_active'], name: 'idx_notification_templates_active' },
    ],
})
export class NotificationTemplateModel
    extends Model<NotificationTemplateModel, INotificationTemplateCreationAttributes>
    implements INotificationTemplateModel
{
    @Column({
        type: DataType.INTEGER,
        primaryKey: true,
        autoIncrement: true,
    })
    declare id: number;

    @Column({
        type: DataType.STRING(50),
        allowNull: false,
        unique: true,
    })
    declare name: string;

    @Column({
        type: DataType.ENUM(...Object.values(NotificationType)),
        allowNull: false,
    })
    declare type: NotificationType;

    @Column({
        type: DataType.STRING(255),
        allowNull: true,
    })
    declare subject: string;

    @Column({
        type: DataType.STRING(255),
        allowNull: false,
    })
    declare title: string;

    @Column({
        type: DataType.TEXT,
        allowNull: false,
    })
    declare message: string;

    @Column({
        type: DataType.ARRAY(DataType.TEXT),
        allowNull: false,
        defaultValue: [],
    })
    declare variables: string[];

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: true,
        field: 'is_active',
    })
    declare isActive: boolean;

    @Column({
        type: DataType.DATE,
        allowNull: false,
        defaultValue: DataType.NOW,
        field: 'created_at',
    })
    declare createdAt: Date;

    @Column({
        type: DataType.DATE,
        allowNull: false,
        defaultValue: DataType.NOW,
        field: 'updated_at',
    })
    declare updatedAt: Date;
}
```

### UserNotificationSettings Model
```typescript
// src/domain/models/user-notification-settings.model.ts
import { Model, DataType, Column, Table, BelongsTo, ForeignKey } from 'sequelize-typescript';
import { UserModel } from './user.model';

interface IUserNotificationSettingsModel {
    id: number;
    userId: number;
    emailEnabled: boolean;
    pushEnabled: boolean;
    orderUpdates: boolean;
    marketing: boolean;
    user: UserModel;
    createdAt: Date;
    updatedAt: Date;
}

interface IUserNotificationSettingsCreationAttributes {
    userId: number;
    emailEnabled?: boolean;
    pushEnabled?: boolean;
    orderUpdates?: boolean;
    marketing?: boolean;
}

@Table({
    tableName: 'user_notification_settings',
    underscored: true,
    timestamps: true,
    indexes: [
        { fields: ['user_id'], name: 'idx_user_notification_settings_user_id', unique: true },
    ],
})
export class UserNotificationSettingsModel
    extends Model<UserNotificationSettingsModel, IUserNotificationSettingsCreationAttributes>
    implements IUserNotificationSettingsModel
{
    @Column({
        type: DataType.INTEGER,
        primaryKey: true,
        autoIncrement: true,
    })
    declare id: number;

    @ForeignKey(() => UserModel)
    @Column({
        type: DataType.INTEGER,
        allowNull: false,
        unique: true,
        field: 'user_id',
    })
    declare userId: number;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: true,
        field: 'email_enabled',
    })
    declare emailEnabled: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: true,
        field: 'push_enabled',
    })
    declare pushEnabled: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: true,
        field: 'order_updates',
    })
    declare orderUpdates: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
    })
    declare marketing: boolean;

    @Column({
        type: DataType.DATE,
        allowNull: false,
        defaultValue: DataType.NOW,
        field: 'created_at',
    })
    declare createdAt: Date;

    @Column({
        type: DataType.DATE,
        allowNull: false,
        defaultValue: DataType.NOW,
        field: 'updated_at',
    })
    declare updatedAt: Date;

    @BelongsTo(() => UserModel)
    declare user: UserModel;
}
```

## –°–µ—Ä–≤–∏—Å—ã

### Notification Service
```typescript
// src/infrastructure/services/notification.service.ts
import { Injectable, Logger, NotFoundException } from '@nestjs/common';
import { InjectModel } from '@nestjs/sequelize';
import { NotificationModel, NotificationType, NotificationStatus } from '@app/domain/models/notification.model';
import { NotificationTemplateModel } from '@app/domain/models/notification-template.model';
import { UserNotificationSettingsModel } from '@app/domain/models/user-notification-settings.model';
import { Op } from 'sequelize';

@Injectable()
export class NotificationService {
    private readonly logger = new Logger(NotificationService.name);

    constructor(
        @InjectModel(NotificationModel)
        private notificationModel: typeof NotificationModel,
        @InjectModel(NotificationTemplateModel)
        private templateModel: typeof NotificationTemplateModel,
        @InjectModel(UserNotificationSettingsModel)
        private settingsModel: typeof UserNotificationSettingsModel,
    ) {}

    async sendNotification(
        userId: number,
        templateName: string,
        variables: Record<string, any> = {},
        type: NotificationType = NotificationType.EMAIL,
    ): Promise<NotificationModel> {
        // –ü–æ–ª—É—á–∞–µ–º —à–∞–±–ª–æ–Ω
        const template = await this.templateModel.findOne({
            where: { 
                name: templateName,
                type,
                isActive: true,
            },
        });

        if (!template) {
            throw new NotFoundException(`–®–∞–±–ª–æ–Ω ${templateName} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userSettings = await this.getUserSettings(userId);
        if (!this.isNotificationEnabled(userSettings, type)) {
            this.logger.log(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ${type} –æ—Ç–∫–ª—é—á–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
            return null;
        }

        // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —à–∞–±–ª–æ–Ω–µ
        const title = this.replaceVariables(template.title, variables);
        const message = this.replaceVariables(template.message, variables);
        const subject = template.subject ? this.replaceVariables(template.subject, variables) : null;

        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = await this.notificationModel.create({
            userId,
            type,
            templateName,
            title,
            message,
            data: { subject, variables },
            status: NotificationStatus.PENDING,
        });

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        try {
            await this.deliverNotification(notification);
            await notification.update({
                status: NotificationStatus.SENT,
                sentAt: new Date(),
            });
        } catch (error) {
            await notification.update({
                status: NotificationStatus.FAILED,
                failedReason: error.message,
            });
            this.logger.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ${notification.id}: ${error.message}`);
        }

        return notification;
    }

    async sendEmailNotification(
        userId: number,
        templateName: string,
        variables: Record<string, any> = {},
    ): Promise<NotificationModel> {
        return this.sendNotification(userId, templateName, variables, NotificationType.EMAIL);
    }

    async sendPushNotification(
        userId: number,
        templateName: string,
        variables: Record<string, any> = {},
    ): Promise<NotificationModel> {
        return this.sendNotification(userId, templateName, variables, NotificationType.PUSH);
    }

    async getUserNotifications(
        userId: number,
        page: number = 1,
        limit: number = 20,
    ): Promise<{ data: NotificationModel[]; total: number }> {
        const { rows: notifications, count: total } = await this.notificationModel.findAndCountAll({
            where: { userId },
            order: [['created_at', 'DESC']],
            limit,
            offset: (page - 1) * limit,
        });

        return { data: notifications, total };
    }

    async markAsRead(notificationId: number, userId: number): Promise<void> {
        const notification = await this.notificationModel.findOne({
            where: { id: notificationId, userId },
        });

        if (!notification) {
            throw new NotFoundException('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        }

        if (notification.status === NotificationStatus.SENT || notification.status === NotificationStatus.DELIVERED) {
            await notification.update({
                status: NotificationStatus.READ,
                readAt: new Date(),
            });
        }
    }

    async getUserSettings(userId: number): Promise<UserNotificationSettingsModel> {
        let settings = await this.settingsModel.findOne({
            where: { userId },
        });

        if (!settings) {
            // –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            settings = await this.settingsModel.create({
                userId,
                emailEnabled: true,
                pushEnabled: true,
                orderUpdates: true,
                marketing: false,
            });
        }

        return settings;
    }

    async updateUserSettings(
        userId: number,
        settings: Partial<Pick<UserNotificationSettingsModel, 'emailEnabled' | 'pushEnabled' | 'orderUpdates' | 'marketing'>>,
    ): Promise<UserNotificationSettingsModel> {
        const userSettings = await this.getUserSettings(userId);
        return userSettings.update(settings);
    }

    async getUnreadCount(userId: number): Promise<number> {
        return this.notificationModel.count({
            where: {
                userId,
                status: {
                    [Op.in]: [NotificationStatus.SENT, NotificationStatus.DELIVERED],
                },
            },
        });
    }

    private isNotificationEnabled(
        settings: UserNotificationSettingsModel,
        type: NotificationType,
    ): boolean {
        if (type === NotificationType.EMAIL) {
            return settings.emailEnabled;
        }
        if (type === NotificationType.PUSH) {
            return settings.pushEnabled;
        }
        return false;
    }

    private replaceVariables(text: string, variables: Record<string, any>): string {
        let result = text;
        Object.keys(variables).forEach(key => {
            const regex = new RegExp(`{{${key}}}`, 'g');
            result = result.replace(regex, variables[key] || '');
        });
        return result;
    }

    private async deliverNotification(notification: NotificationModel): Promise<void> {
        // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å email/SMS/push –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏
        // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        this.logger.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ ${notification.type} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${notification.userId}: ${notification.title}`);
        
        // –°–∏–º—É–ª—è—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        await new Promise(resolve => setTimeout(resolve, 100));
    }
}
```

## –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã

### Notification Controller
```typescript
// src/infrastructure/controllers/notification.controller.ts
import { Controller, Get, Post, Put, Param, Body, Query, HttpCode, HttpStatus, UseGuards } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiQuery, ApiBearerAuth } from '@nestjs/swagger';
import { AuthGuard } from '@app/infrastructure/common/guards/auth.guard';
import { CurrentUser } from '@app/infrastructure/common/decorators/current-user.decorator';
import { NotificationService } from '@app/infrastructure/services/notification.service';
import { MarkAsReadDto } from '@app/infrastructure/dto/notification/mark-as-read.dto';
import { UpdateSettingsDto } from '@app/infrastructure/dto/notification/update-settings.dto';
import { NotificationResponse, UserNotificationSettingsResponse } from '@app/infrastructure/responses/notification/notification.response';

@ApiTags('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è')
@Controller('notifications')
export class NotificationController {
    constructor(private readonly notificationService: NotificationService) {}

    @Get()
    @HttpCode(HttpStatus.OK)
    @UseGuards(AuthGuard)
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' })
    @ApiQuery({ name: 'page', required: false, description: '–ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã' })
    @ApiQuery({ name: 'limit', required: false, description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ' })
    @ApiResponse({ status: 200, description: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã', type: [NotificationResponse] })
    async getUserNotifications(
        @CurrentUser() user: any,
        @Query('page') page: number = 1,
        @Query('limit') limit: number = 20,
    ): Promise<{ data: NotificationResponse[]; total: number }> {
        const result = await this.notificationService.getUserNotifications(user.id, page, limit);
        
        return {
            data: result.data.map(notification => ({
                id: notification.id,
                userId: notification.userId,
                type: notification.type,
                templateName: notification.templateName,
                title: notification.title,
                message: notification.message,
                data: notification.data,
                status: notification.status,
                sentAt: notification.sentAt,
                readAt: notification.readAt,
                failedReason: notification.failedReason,
                createdAt: notification.createdAt,
            })),
            total: result.total,
        };
    }

    @Get('unread-count')
    @HttpCode(HttpStatus.OK)
    @UseGuards(AuthGuard)
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π' })
    @ApiResponse({ status: 200, description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π' })
    async getUnreadCount(@CurrentUser() user: any): Promise<{ count: number }> {
        const count = await this.notificationService.getUnreadCount(user.id);
        return { count };
    }

    @Put(':id/read')
    @HttpCode(HttpStatus.OK)
    @UseGuards(AuthGuard)
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–û—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ' })
    @ApiResponse({ status: 200, description: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ' })
    @ApiResponse({ status: 404, description: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' })
    async markAsRead(
        @Param('id') notificationId: number,
        @CurrentUser() user: any,
    ): Promise<{ message: string }> {
        await this.notificationService.markAsRead(notificationId, user.id);
        return { message: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ' };
    }

    @Get('settings')
    @HttpCode(HttpStatus.OK)
    @UseGuards(AuthGuard)
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' })
    @ApiResponse({ status: 200, description: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã', type: UserNotificationSettingsResponse })
    async getUserSettings(@CurrentUser() user: any): Promise<UserNotificationSettingsResponse> {
        const settings = await this.notificationService.getUserSettings(user.id);
        
        return {
            id: settings.id,
            userId: settings.userId,
            emailEnabled: settings.emailEnabled,
            pushEnabled: settings.pushEnabled,
            orderUpdates: settings.orderUpdates,
            marketing: settings.marketing,
            createdAt: settings.createdAt,
            updatedAt: settings.updatedAt,
        };
    }

    @Put('settings')
    @HttpCode(HttpStatus.OK)
    @UseGuards(AuthGuard)
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' })
    @ApiResponse({ status: 200, description: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', type: UserNotificationSettingsResponse })
    async updateUserSettings(
        @Body() updateSettingsDto: UpdateSettingsDto,
        @CurrentUser() user: any,
    ): Promise<UserNotificationSettingsResponse> {
        const settings = await this.notificationService.updateUserSettings(user.id, updateSettingsDto);
        
        return {
            id: settings.id,
            userId: settings.userId,
            emailEnabled: settings.emailEnabled,
            pushEnabled: settings.pushEnabled,
            orderUpdates: settings.orderUpdates,
            marketing: settings.marketing,
            createdAt: settings.createdAt,
            updatedAt: settings.updatedAt,
        };
    }
}
```

## –ú–∏–≥—Ä–∞—Ü–∏–∏

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```typescript
// db/migrations/YYYYMMDDHHMMSS-create-notification-system.ts
import { QueryInterface, DataTypes } from 'sequelize';

export async function up(queryInterface: QueryInterface): Promise<void> {
    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã notifications
    await queryInterface.createTable('notifications', {
        id: {
            type: DataTypes.INTEGER,
            primaryKey: true,
            autoIncrement: true,
        },
        user_id: {
            type: DataTypes.INTEGER,
            allowNull: false,
            references: { model: 'users', key: 'id' },
            onDelete: 'CASCADE',
        },
        type: {
            type: DataTypes.ENUM('email', 'push'),
            allowNull: false,
        },
        template_name: {
            type: DataTypes.STRING(50),
            allowNull: false,
        },
        title: {
            type: DataTypes.STRING(255),
            allowNull: false,
        },
        message: {
            type: DataTypes.TEXT,
            allowNull: false,
        },
        data: {
            type: DataTypes.JSONB,
            allowNull: true,
        },
        status: {
            type: DataTypes.ENUM('pending', 'sent', 'delivered', 'read', 'failed'),
            allowNull: false,
            defaultValue: 'pending',
        },
        sent_at: {
            type: DataTypes.DATE,
            allowNull: true,
        },
        read_at: {
            type: DataTypes.DATE,
            allowNull: true,
        },
        failed_reason: {
            type: DataTypes.TEXT,
            allowNull: true,
        },
        created_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã notification_templates
    await queryInterface.createTable('notification_templates', {
        id: {
            type: DataTypes.INTEGER,
            primaryKey: true,
            autoIncrement: true,
        },
        name: {
            type: DataTypes.STRING(50),
            allowNull: false,
            unique: true,
        },
        type: {
            type: DataTypes.ENUM('email', 'push'),
            allowNull: false,
        },
        subject: {
            type: DataTypes.STRING(255),
            allowNull: true,
        },
        title: {
            type: DataTypes.STRING(255),
            allowNull: false,
        },
        message: {
            type: DataTypes.TEXT,
            allowNull: false,
        },
        variables: {
            type: DataTypes.ARRAY(DataTypes.TEXT),
            allowNull: false,
            defaultValue: [],
        },
        is_active: {
            type: DataTypes.BOOLEAN,
            allowNull: false,
            defaultValue: true,
        },
        created_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
        updated_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã user_notification_settings
    await queryInterface.createTable('user_notification_settings', {
        id: {
            type: DataTypes.INTEGER,
            primaryKey: true,
            autoIncrement: true,
        },
        user_id: {
            type: DataTypes.INTEGER,
            allowNull: false,
            references: { model: 'users', key: 'id' },
            onDelete: 'CASCADE',
            unique: true,
        },
        email_enabled: {
            type: DataTypes.BOOLEAN,
            allowNull: false,
            defaultValue: true,
        },
        push_enabled: {
            type: DataTypes.BOOLEAN,
            allowNull: false,
            defaultValue: true,
        },
        order_updates: {
            type: DataTypes.BOOLEAN,
            allowNull: false,
            defaultValue: true,
        },
        marketing: {
            type: DataTypes.BOOLEAN,
            allowNull: false,
            defaultValue: false,
        },
        created_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
        updated_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
    await queryInterface.addIndex('notifications', ['user_id']);
    await queryInterface.addIndex('notifications', ['type']);
    await queryInterface.addIndex('notifications', ['status']);
    await queryInterface.addIndex('notifications', ['template_name']);
    await queryInterface.addIndex('notifications', ['created_at']);
    await queryInterface.addIndex('notifications', ['user_id', 'status']);

    await queryInterface.addIndex('notification_templates', ['name'], { unique: true });
    await queryInterface.addIndex('notification_templates', ['type']);
    await queryInterface.addIndex('notification_templates', ['is_active']);

    await queryInterface.addIndex('user_notification_settings', ['user_id'], { unique: true });
}

export async function down(queryInterface: QueryInterface): Promise<void> {
    await queryInterface.dropTable('user_notification_settings');
    await queryInterface.dropTable('notification_templates');
    await queryInterface.dropTable('notifications');
}
```

### –°–∏–¥—ã –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```typescript
// db/seeders/YYYYMMDDHHMMSS-notification-templates.ts
import { QueryInterface } from 'sequelize';

export async function up(queryInterface: QueryInterface): Promise<void> {
    await queryInterface.bulkInsert('notification_templates', [
        {
            name: 'order_confirmation',
            type: 'email',
            subject: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ #{{orderNumber}}',
            title: '–ó–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
            message: '–í–∞—à –∑–∞–∫–∞–∑ #{{orderNumber}} –Ω–∞ —Å—É–º–º—É {{totalAmount}} —Ä—É–±. –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –∏ –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É.',
            variables: JSON.stringify(['orderNumber', 'totalAmount']),
            is_active: true,
            created_at: new Date(),
            updated_at: new Date(),
        },
        {
            name: 'order_shipped',
            type: 'email',
            subject: '–ó–∞–∫–∞–∑ #{{orderNumber}} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',
            title: '–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',
            message: '–í–∞—à –∑–∞–∫–∞–∑ #{{orderNumber}} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –¢—Ä–µ–∫-–Ω–æ–º–µ—Ä: {{trackingNumber}}',
            variables: JSON.stringify(['orderNumber', 'trackingNumber']),
            is_active: true,
            created_at: new Date(),
            updated_at: new Date(),
        },
        {
            name: 'password_reset',
            type: 'email',
            subject: '–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è',
            title: '–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è',
            message: '–î–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: {{resetLink}}',
            variables: JSON.stringify(['resetLink']),
            is_active: true,
            created_at: new Date(),
            updated_at: new Date(),
        },
        {
            name: 'welcome',
            type: 'email',
            subject: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
            title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –º–∞–≥–∞–∑–∏–Ω',
            message: '–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω.',
            variables: JSON.stringify([]),
            is_active: true,
            created_at: new Date(),
            updated_at: new Date(),
        },
        {
            name: 'order_confirmation_push',
            type: 'push',
            title: '–ó–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
            message: '–í–∞—à –∑–∞–∫–∞–∑ #{{orderNumber}} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
            variables: JSON.stringify(['orderNumber']),
            is_active: true,
            created_at: new Date(),
            updated_at: new Date(),
        },
        {
            name: 'order_shipped_push',
            type: 'push',
            title: '–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',
            message: '–í–∞—à –∑–∞–∫–∞–∑ #{{orderNumber}} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',
            variables: JSON.stringify(['orderNumber']),
            is_active: true,
            created_at: new Date(),
            updated_at: new Date(),
        },
    ]);
}

export async function down(queryInterface: QueryInterface): Promise<void> {
    await queryInterface.bulkDelete('notification_templates', null, {});
}
```

## DTO –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

### MarkAsReadDto
```typescript
// src/infrastructure/dto/notification/mark-as-read.dto.ts
import { IsNumber, Min } from 'class-validator';

export class MarkAsReadDto {
    @IsNumber({}, { message: 'ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Min(1, { message: 'ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0' })
    declare readonly notificationId: number;
}
```

### UpdateSettingsDto
```typescript
// src/infrastructure/dto/notification/update-settings.dto.ts
import { IsOptional, IsBoolean } from 'class-validator';

export class UpdateSettingsDto {
    @IsOptional()
    @IsBoolean({ message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ email –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±—É–ª–µ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º' })
    declare readonly emailEnabled?: boolean;

    @IsOptional()
    @IsBoolean({ message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ push –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±—É–ª–µ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º' })
    declare readonly pushEnabled?: boolean;

    @IsOptional()
    @IsBoolean({ message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±—É–ª–µ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º' })
    declare readonly orderUpdates?: boolean;

    @IsOptional()
    @IsBoolean({ message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±—É–ª–µ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º' })
    declare readonly marketing?: boolean;
}
```

## Response –∫–ª–∞—Å—Å—ã

### NotificationResponse
```typescript
// src/infrastructure/responses/notification/notification.response.ts
import { ApiProperty } from '@nestjs/swagger';

export class NotificationResponse {
    @ApiProperty({ description: 'ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' })
    declare readonly id: number;

    @ApiProperty({ description: 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' })
    declare readonly userId: number;

    @ApiProperty({ description: '–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' })
    declare readonly type: string;

    @ApiProperty({ description: '–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞' })
    declare readonly templateName: string;

    @ApiProperty({ description: '–ó–∞–≥–æ–ª–æ–≤–æ–∫' })
    declare readonly title: string;

    @ApiProperty({ description: '–°–æ–æ–±—â–µ–Ω–∏–µ' })
    declare readonly message: string;

    @ApiProperty({ description: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', required: false })
    declare readonly data?: any;

    @ApiProperty({ description: '–°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' })
    declare readonly status: string;

    @ApiProperty({ description: '–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', required: false })
    declare readonly sentAt?: Date;

    @ApiProperty({ description: '–î–∞—Ç–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è', required: false })
    declare readonly readAt?: Date;

    @ApiProperty({ description: '–ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏', required: false })
    declare readonly failedReason?: string;

    @ApiProperty({ description: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è' })
    declare readonly createdAt: Date;
}
```

### UserNotificationSettingsResponse
```typescript
// src/infrastructure/responses/notification/notification.response.ts
import { ApiProperty } from '@nestjs/swagger';

export class UserNotificationSettingsResponse {
    @ApiProperty({ description: 'ID –Ω–∞—Å—Ç—Ä–æ–µ–∫' })
    declare readonly id: number;

    @ApiProperty({ description: 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' })
    declare readonly userId: number;

    @ApiProperty({ description: 'Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã' })
    declare readonly emailEnabled: boolean;

    @ApiProperty({ description: 'Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã' })
    declare readonly pushEnabled: boolean;

    @ApiProperty({ description: '–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤–∫–ª—é—á–µ–Ω—ã' })
    declare readonly orderUpdates: boolean;

    @ApiProperty({ description: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã' })
    declare readonly marketing: boolean;

    @ApiProperty({ description: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è' })
    declare readonly createdAt: Date;

    @ApiProperty({ description: '–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' })
    declare readonly updatedAt: Date;
}
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- [ ] –°–æ–∑–¥–∞–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü notifications, notification_templates, user_notification_settings
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–æ–¥–µ–ª–∏ Sequelize (NotificationModel, NotificationTemplateModel, UserNotificationSettingsModel)
- [ ] –°–æ–∑–¥–∞–Ω NotificationService —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å API endpoints
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã DTO –∫–ª–∞—Å—Å—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- [ ] –°–æ–∑–¥–∞–Ω—ã Response –∫–ª–∞—Å—Å—ã —Å Swagger
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –°–æ–∑–¥–∞–Ω—ã —Å–∏–¥—ã –¥–ª—è –±–∞–∑–æ–≤—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã unit —Ç–µ—Å—Ç—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã integration —Ç–µ—Å—Ç—ã –¥–ª—è API
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å email/push –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏

### üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- [ ] SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç–∏
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (1 –Ω–µ–¥–µ–ª—è)
1. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏** Sequelize
3. **–°–æ–∑–¥–∞—Ç—å DTO –∫–ª–∞—Å—Å—ã** —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
4. **–°–æ–∑–¥–∞—Ç—å Response –∫–ª–∞—Å—Å—ã** —Å Swagger
5. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å** —Å –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–æ–π

### –§–∞–∑–∞ 2: API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (3-4 –¥–Ω—è)
6. **–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä** —Å API endpoints
7. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é** —Å email –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏
8. **–î–æ–±–∞–≤–∏—Ç—å push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
9. **–°–æ–∑–¥–∞—Ç—å —Å–∏–¥—ã** –¥–ª—è –±–∞–∑–æ–≤—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤

### –§–∞–∑–∞ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–∞—á–µ—Å—Ç–≤–æ (2-3 –¥–Ω—è)
10. **–ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã** –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
11. **–ù–∞–ø–∏—Å–∞—Ç—å integration —Ç–µ—Å—Ç—ã** –¥–ª—è API
12. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫** –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é
13. **–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥** –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é

## –†–∏—Å–∫–∏ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

### ‚ö†Ô∏è –†–∏—Å–∫–∏:
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
- **–î–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç—å**: email –º–æ–≥—É—Ç –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Å–ø–∞–º
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –Ω—É–∂–Ω–∞ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:
- **–û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π**: Redis/RabbitMQ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã**: SendGrid, Twilio –¥–ª—è email/SMS
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

### üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã:
- **OrderService** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö
- **UserService** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **AuthService** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è
- **EmailService** - –æ—Ç–ø—Ä–∞–≤–∫–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **PushService** - –æ—Ç–ø—Ä–∞–≤–∫–∞ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞:
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç–∏
- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã

## TL;DR

–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–∫–ª—é—á–∞–µ—Ç:
- **3 —Ç–∞–±–ª–∏—Ü—ã**: notifications, notification_templates, user_notification_settings
- **3 –º–æ–¥–µ–ª–∏**: NotificationModel, NotificationTemplateModel, UserNotificationSettingsModel
- **1 —Å–µ—Ä–≤–∏—Å**: NotificationService
- **1 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä**: NotificationController
- **–§—É–Ω–∫—Ü–∏–∏**: email –∏ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —à–∞–±–ª–æ–Ω—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ —à–∞–±–ª–æ–Ω–æ–≤
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**: –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ —Å–æ–±—ã—Ç–∏—è–º
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å**: –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º
```