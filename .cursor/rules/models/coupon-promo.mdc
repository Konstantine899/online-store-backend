# –°–∏—Å—Ç–µ–º–∞ –∫—É–ø–æ–Ω–æ–≤ (Coupon System) - Ecommerce Edition

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ü–µ–ª—å
–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∫—É–ø–æ–Ω–æ–≤ –¥–ª—è ecommerce –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –±–∞–∑–æ–≤—ã–º–∏ —Ç–∏–ø–∞–º–∏ —Å–∫–∏–¥–æ–∫, —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –±—ã—Å—Ç—Ä—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- **–¢–∏–ø—ã —Å–∫–∏–¥–æ–∫** - –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ, —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** - –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º–µ
- **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ –∫—É–ø–æ–Ω–æ–≤
- **–ò—Å—Ç–æ—Ä–∏—è** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—É–ø–æ–Ω–æ–≤
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `coupons`
```sql
CREATE TABLE coupons (
    id SERIAL PRIMARY KEY,
    code VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    type VARCHAR(20) NOT NULL CHECK (type IN ('percentage', 'fixed', 'free_shipping')),
    value DECIMAL(10,2) NOT NULL,
    min_order_amount DECIMAL(10,2) DEFAULT 0.00,
    max_discount DECIMAL(10,2),
    usage_limit INTEGER,
    usage_count INTEGER DEFAULT 0,
    user_limit INTEGER DEFAULT 1,
    valid_from TIMESTAMP NOT NULL,
    valid_to TIMESTAMP NOT NULL,
    is_active BOOLEAN DEFAULT true,
    applicable_products INTEGER[],
    applicable_categories INTEGER[],
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### –¢–∞–±–ª–∏—Ü–∞ `coupon_usage`
```sql
CREATE TABLE coupon_usage (
    id SERIAL PRIMARY KEY,
    coupon_id INTEGER REFERENCES coupons(id) ON DELETE CASCADE,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,
    discount_amount DECIMAL(10,2) NOT NULL,
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## –ú–æ–¥–µ–ª–∏ Sequelize

### Coupon Model
```typescript
// src/domain/models/coupon.model.ts
import { Model, DataType, Column, Table, HasMany } from 'sequelize-typescript';
import { CouponUsageModel } from './coupon-usage.model';

export enum CouponType {
    PERCENTAGE = 'percentage',
    FIXED = 'fixed',
    FREE_SHIPPING = 'free_shipping'
}

interface ICouponModel {
    id: number;
    code: string;
    name: string;
    description?: string;
    type: CouponType;
    value: number;
    minOrderAmount: number;
    maxDiscount?: number;
    usageLimit?: number;
    usageCount: number;
    userLimit: number;
    validFrom: Date;
    validTo: Date;
    isActive: boolean;
    applicableProducts?: number[];
    applicableCategories?: number[];
    usages: CouponUsageModel[];
    createdAt: Date;
    updatedAt: Date;
}

interface ICouponCreationAttributes {
    code: string;
    name: string;
    description?: string;
    type: CouponType;
    value: number;
    minOrderAmount?: number;
    maxDiscount?: number;
    usageLimit?: number;
    userLimit?: number;
    validFrom: Date;
    validTo: Date;
    isActive?: boolean;
    applicableProducts?: number[];
    applicableCategories?: number[];
}

@Table({
    tableName: 'coupons',
    underscored: true,
    timestamps: true,
    indexes: [
        { fields: ['code'], name: 'idx_coupons_code', unique: true },
        { fields: ['type'], name: 'idx_coupons_type' },
        { fields: ['is_active'], name: 'idx_coupons_is_active' },
        { fields: ['valid_from', 'valid_to'], name: 'idx_coupons_validity' },
    ],
})
export class CouponModel
    extends Model<CouponModel, ICouponCreationAttributes>
    implements ICouponModel
{
    @Column({
        type: DataType.INTEGER,
        primaryKey: true,
        autoIncrement: true,
    })
    declare id: number;

    @Column({
        type: DataType.STRING(50),
        allowNull: false,
        unique: true,
    })
    declare code: string;

    @Column({
        type: DataType.STRING(100),
        allowNull: false,
    })
    declare name: string;

    @Column({
        type: DataType.TEXT,
        allowNull: true,
    })
    declare description: string;

    @Column({
        type: DataType.ENUM(...Object.values(CouponType)),
        allowNull: false,
    })
    declare type: CouponType;

    @Column({
        type: DataType.DECIMAL(10, 2),
        allowNull: false,
    })
    declare value: number;

    @Column({
        type: DataType.DECIMAL(10, 2),
        allowNull: false,
        defaultValue: 0.00,
        field: 'min_order_amount',
    })
    declare minOrderAmount: number;

    @Column({
        type: DataType.DECIMAL(10, 2),
        allowNull: true,
        field: 'max_discount',
    })
    declare maxDiscount: number;

    @Column({
        type: DataType.INTEGER,
        allowNull: true,
        field: 'usage_limit',
    })
    declare usageLimit: number;

    @Column({
        type: DataType.INTEGER,
        allowNull: false,
        defaultValue: 0,
        field: 'usage_count',
    })
    declare usageCount: number;

    @Column({
        type: DataType.INTEGER,
        allowNull: false,
        defaultValue: 1,
        field: 'user_limit',
    })
    declare userLimit: number;

    @Column({
        type: DataType.DATE,
        allowNull: false,
        field: 'valid_from',
    })
    declare validFrom: Date;

    @Column({
        type: DataType.DATE,
        allowNull: false,
        field: 'valid_to',
    })
    declare validTo: Date;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: true,
        field: 'is_active',
    })
    declare isActive: boolean;

    @Column({
        type: DataType.ARRAY(DataType.INTEGER),
        allowNull: true,
        field: 'applicable_products',
    })
    declare applicableProducts: number[];

    @Column({
        type: DataType.ARRAY(DataType.INTEGER),
        allowNull: true,
        field: 'applicable_categories',
    })
    declare applicableCategories: number[];

    @HasMany(() => CouponUsageModel)
    declare usages: CouponUsageModel[];
}
```

### CouponUsage Model
```typescript
// src/domain/models/coupon-usage.model.ts
import { Model, DataType, Column, Table, BelongsTo, ForeignKey } from 'sequelize-typescript';
import { CouponModel } from './coupon.model';
import { UserModel } from './user.model';
import { OrderModel } from './order.model';

interface ICouponUsageModel {
    id: number;
    couponId: number;
    userId: number;
    orderId: number;
    discountAmount: number;
    coupon: CouponModel;
    user: UserModel;
    order: OrderModel;
    usedAt: Date;
}

interface ICouponUsageCreationAttributes {
    couponId: number;
    userId: number;
    orderId: number;
    discountAmount: number;
}

@Table({
    tableName: 'coupon_usage',
    underscored: true,
    timestamps: true,
    createdAt: 'usedAt',
    updatedAt: false,
    indexes: [
        { fields: ['coupon_id'], name: 'idx_coupon_usage_coupon_id' },
        { fields: ['user_id'], name: 'idx_coupon_usage_user_id' },
        { fields: ['order_id'], name: 'idx_coupon_usage_order_id' },
        { fields: ['used_at'], name: 'idx_coupon_usage_used_at' },
    ],
})
export class CouponUsageModel
    extends Model<CouponUsageModel, ICouponUsageCreationAttributes>
    implements ICouponUsageModel
{
    @Column({
        type: DataType.INTEGER,
        primaryKey: true,
        autoIncrement: true,
    })
    declare id: number;

    @ForeignKey(() => CouponModel)
    @Column({
        type: DataType.INTEGER,
        allowNull: false,
        field: 'coupon_id',
    })
    declare couponId: number;

    @ForeignKey(() => UserModel)
    @Column({
        type: DataType.INTEGER,
        allowNull: false,
        field: 'user_id',
    })
    declare userId: number;

    @ForeignKey(() => OrderModel)
    @Column({
        type: DataType.INTEGER,
        allowNull: false,
        field: 'order_id',
    })
    declare orderId: number;

    @Column({
        type: DataType.DECIMAL(10, 2),
        allowNull: false,
        field: 'discount_amount',
    })
    declare discountAmount: number;

    @Column({
        type: DataType.DATE,
        allowNull: false,
        defaultValue: DataType.NOW,
        field: 'used_at',
    })
    declare usedAt: Date;

    @BelongsTo(() => CouponModel)
    declare coupon: CouponModel;

    @BelongsTo(() => UserModel)
    declare user: UserModel;

    @BelongsTo(() => OrderModel)
    declare order: OrderModel;
}
```

## –°–µ—Ä–≤–∏—Å—ã

### Coupon Service
```typescript
// src/infrastructure/services/coupon.service.ts
import { Injectable, Logger, NotFoundException, BadRequestException } from '@nestjs/common';
import { InjectModel } from '@nestjs/sequelize';
import { CouponModel, CouponType } from '@app/domain/models/coupon.model';
import { CouponUsageModel } from '@app/domain/models/coupon-usage.model';
import { Op } from 'sequelize';

@Injectable()
export class CouponService {
    private readonly logger = new Logger(CouponService.name);

    constructor(
        @InjectModel(CouponModel)
        private couponModel: typeof CouponModel,
        @InjectModel(CouponUsageModel)
        private couponUsageModel: typeof CouponUsageModel,
    ) {}

    async findAll(
        page: number = 1,
        limit: number = 10,
        search?: string,
        isActive?: boolean,
    ): Promise<{ data: CouponModel[]; total: number }> {
        const where: any = {};

        if (search) {
            where[Op.or] = [
                { code: { [Op.iLike]: `%${search}%` } },
                { name: { [Op.iLike]: `%${search}%` } },
            ];
        }

        if (isActive !== undefined) {
            where.isActive = isActive;
        }

        const { rows: coupons, count: total } = await this.couponModel.findAndCountAll({
            where,
            order: [['created_at', 'DESC']],
            limit,
            offset: (page - 1) * limit,
            include: [
                {
                    model: CouponUsageModel,
                    attributes: ['id'],
                    required: false,
                },
            ],
        });

        return { data: coupons, total };
    }

    async findById(id: number): Promise<CouponModel> {
        const coupon = await this.couponModel.findByPk(id, {
            include: [
                {
                    model: CouponUsageModel,
                    include: ['user', 'order'],
                    required: false,
                },
            ],
        });

        if (!coupon) {
            throw new NotFoundException('–ö—É–ø–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        return coupon;
    }

    async findByCode(code: string): Promise<CouponModel> {
        const coupon = await this.couponModel.findOne({
            where: { code: code.toUpperCase() },
        });

        if (!coupon) {
            throw new NotFoundException('–ö—É–ø–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        return coupon;
    }

    async create(couponData: Partial<CouponModel>): Promise<CouponModel> {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞
        const existingCoupon = await this.couponModel.findOne({
            where: { code: couponData.code.toUpperCase() },
        });

        if (existingCoupon) {
            throw new BadRequestException('–ö—É–ø–æ–Ω —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        }

        const coupon = await this.couponModel.create({
            ...couponData,
            code: couponData.code.toUpperCase(),
        });

        this.logger.log(`Coupon created: ${coupon.code} (${coupon.name})`);
        return coupon;
    }

    async update(id: number, couponData: Partial<CouponModel>): Promise<CouponModel> {
        const coupon = await this.findById(id);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        if (couponData.code && couponData.code !== coupon.code) {
            const existingCoupon = await this.couponModel.findOne({
                where: { code: couponData.code.toUpperCase() },
            });

            if (existingCoupon) {
                throw new BadRequestException('–ö—É–ø–æ–Ω —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            }
        }

        await coupon.update({
            ...couponData,
            code: couponData.code ? couponData.code.toUpperCase() : coupon.code,
        });

        this.logger.log(`Coupon updated: ${coupon.code} (${coupon.name})`);
        return coupon;
    }

    async delete(id: number): Promise<void> {
        const coupon = await this.findById(id);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—É–ø–æ–Ω–∞
        const usageCount = await this.couponUsageModel.count({
            where: { couponId: id },
        });

        if (usageCount > 0) {
            throw new BadRequestException('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫—É–ø–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è');
        }

        await coupon.destroy();
        this.logger.log(`Coupon deleted: ${coupon.code} (${coupon.name})`);
    }

    async validateCoupon(
        code: string,
        userId: number,
        orderAmount: number,
        productIds?: number[],
        categoryIds?: number[],
    ): Promise<{ isValid: boolean; message?: string; coupon?: CouponModel; discount?: number }> {
        try {
            const coupon = await this.findByCode(code.toUpperCase());

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            if (!coupon.isActive) {
                return { isValid: false, message: '–ö—É–ø–æ–Ω –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω' };
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
            const now = new Date();
            if (now < coupon.validFrom || now > coupon.validTo) {
                return { isValid: false, message: '–ö—É–ø–æ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç' };
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
            if (orderAmount < coupon.minOrderAmount) {
                return { 
                    isValid: false, 
                    message: `–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—É–ø–æ–Ω–∞: ${coupon.minOrderAmount} —Ä—É–±.` 
                };
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            if (coupon.usageLimit && coupon.usageCount >= coupon.usageLimit) {
                return { isValid: false, message: '–ö—É–ø–æ–Ω –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' };
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            const userUsageCount = await this.couponUsageModel.count({
                where: { couponId: coupon.id, userId },
            });

            if (userUsageCount >= coupon.userLimit) {
                return { isValid: false, message: '–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –∫—É–ø–æ–Ω –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑' };
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å –∫ —Ç–æ–≤–∞—Ä–∞–º
            if (coupon.applicableProducts && productIds) {
                const hasApplicableProduct = productIds.some(id => 
                    coupon.applicableProducts.includes(id)
                );
                if (!hasApplicableProduct) {
                    return { isValid: false, message: '–ö—É–ø–æ–Ω –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º' };
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            if (coupon.applicableCategories && categoryIds) {
                const hasApplicableCategory = categoryIds.some(id => 
                    coupon.applicableCategories.includes(id)
                );
                if (!hasApplicableCategory) {
                    return { isValid: false, message: '–ö—É–ø–æ–Ω –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º' };
                }
            }

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É
            let discount = 0;
            switch (coupon.type) {
                case CouponType.PERCENTAGE:
                    discount = (orderAmount * coupon.value) / 100;
                    if (coupon.maxDiscount && discount > coupon.maxDiscount) {
                        discount = coupon.maxDiscount;
                    }
                    break;
                case CouponType.FIXED:
                    discount = coupon.value;
                    break;
                case CouponType.FREE_SHIPPING:
                    discount = 0; // –õ–æ–≥–∏–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
                    break;
            }

            return { isValid: true, coupon, discount };
        } catch (error) {
            if (error instanceof NotFoundException) {
                return { isValid: false, message: '–ö—É–ø–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω' };
            }
            throw error;
        }
    }

    async applyCoupon(
        couponId: number,
        userId: number,
        orderId: number,
        discountAmount: number,
    ): Promise<CouponUsageModel> {
        const coupon = await this.findById(couponId);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        if (coupon.usageLimit && coupon.usageCount >= coupon.usageLimit) {
            throw new BadRequestException('–ö—É–ø–æ–Ω –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω');
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        const userUsageCount = await this.couponUsageModel.count({
            where: { couponId, userId },
        });

        if (userUsageCount >= coupon.userLimit) {
            throw new BadRequestException('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –∫—É–ø–æ–Ω –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑');
        }

        // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
        const usage = await this.couponUsageModel.create({
            couponId,
            userId,
            orderId,
            discountAmount,
        });

        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        await coupon.update({
            usageCount: coupon.usageCount + 1,
        });

        this.logger.log(`Coupon ${coupon.code} applied to order ${orderId}`);
        return usage;
    }

    async getCouponUsage(couponId: number): Promise<CouponUsageModel[]> {
        return this.couponUsageModel.findAll({
            where: { couponId },
            include: ['user', 'order'],
            order: [['used_at', 'DESC']],
        });
    }

    async getActiveCoupons(): Promise<CouponModel[]> {
        const now = new Date();
        return this.couponModel.findAll({
            where: {
                isActive: true,
                validFrom: { [Op.lte]: now },
                validTo: { [Op.gte]: now },
            },
            order: [['created_at', 'DESC']],
        });
    }
}
```

## –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã

### Coupon Controller
```typescript
// src/infrastructure/controllers/coupon.controller.ts
import { Controller, Get, Post, Put, Delete, Param, Body, Query, HttpCode, HttpStatus, UseGuards } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiQuery, ApiBearerAuth } from '@nestjs/swagger';
import { AuthGuard } from '@app/infrastructure/common/guards/auth.guard';
import { RoleGuard } from '@app/infrastructure/common/guards/role.guard';
import { Roles } from '@app/infrastructure/common/decorators/roles.decorator';
import { CurrentUser } from '@app/infrastructure/common/decorators/current-user.decorator';
import { CouponService } from '@app/infrastructure/services/coupon.service';
import { CreateCouponDto } from '@app/infrastructure/dto/coupon/create-coupon.dto';
import { UpdateCouponDto } from '@app/infrastructure/dto/coupon/update-coupon.dto';
import { ValidateCouponDto } from '@app/infrastructure/dto/coupon/validate-coupon.dto';
import { CouponResponse, CouponListResponse } from '@app/infrastructure/responses/coupon/coupon.response';

@ApiTags('–ö—É–ø–æ–Ω—ã')
@Controller('coupons')
export class CouponController {
    constructor(private readonly couponService: CouponService) {}

    @Get()
    @HttpCode(HttpStatus.OK)
    @UseGuards(AuthGuard, RoleGuard)
    @Roles('ADMIN')
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫—É–ø–æ–Ω–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)' })
    @ApiQuery({ name: 'page', required: false, description: '–ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã' })
    @ApiQuery({ name: 'limit', required: false, description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ' })
    @ApiQuery({ name: 'search', required: false, description: '–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é' })
    @ApiQuery({ name: 'isActive', required: false, description: '–§–∏–ª—å—Ç—Ä –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏' })
    @ApiResponse({ status: 200, description: '–°–ø–∏—Å–æ–∫ –∫—É–ø–æ–Ω–æ–≤ –ø–æ–ª—É—á–µ–Ω', type: CouponListResponse })
    async getCoupons(
        @Query('page') page: number = 1,
        @Query('limit') limit: number = 10,
        @Query('search') search?: string,
        @Query('isActive') isActive?: boolean,
    ): Promise<CouponListResponse> {
        const result = await this.couponService.findAll(page, limit, search, isActive);
        
        return {
            data: result.data.map(coupon => ({
                id: coupon.id,
                code: coupon.code,
                name: coupon.name,
                description: coupon.description,
                type: coupon.type,
                value: coupon.value,
                minOrderAmount: coupon.minOrderAmount,
                maxDiscount: coupon.maxDiscount,
                usageLimit: coupon.usageLimit,
                usageCount: coupon.usageCount,
                userLimit: coupon.userLimit,
                validFrom: coupon.validFrom,
                validTo: coupon.validTo,
                isActive: coupon.isActive,
                applicableProducts: coupon.applicableProducts,
                applicableCategories: coupon.applicableCategories,
                createdAt: coupon.createdAt,
                updatedAt: coupon.updatedAt,
            })),
            meta: {
                totalCount: result.total,
                currentPage: page,
                limit,
                lastPage: Math.ceil(result.total / limit),
                nextPage: page < Math.ceil(result.total / limit) ? page + 1 : null,
                previousPage: page > 1 ? page - 1 : null,
            },
        };
    }

    @Get('active')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∫—É–ø–æ–Ω—ã' })
    @ApiResponse({ status: 200, description: '–ê–∫—Ç–∏–≤–Ω—ã–µ –∫—É–ø–æ–Ω—ã –ø–æ–ª—É—á–µ–Ω—ã', type: [CouponResponse] })
    async getActiveCoupons(): Promise<CouponResponse[]> {
        const coupons = await this.couponService.getActiveCoupons();
        
        return coupons.map(coupon => ({
            id: coupon.id,
            code: coupon.code,
            name: coupon.name,
            description: coupon.description,
            type: coupon.type,
            value: coupon.value,
            minOrderAmount: coupon.minOrderAmount,
            maxDiscount: coupon.maxDiscount,
            validFrom: coupon.validFrom,
            validTo: coupon.validTo,
        }));
    }

    @Post('validate')
    @HttpCode(HttpStatus.OK)
    @UseGuards(AuthGuard)
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—É–ø–æ–Ω' })
    @ApiResponse({ status: 200, description: '–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—É–ø–æ–Ω–∞' })
    async validateCoupon(
        @Body() validateCouponDto: ValidateCouponDto,
        @CurrentUser() user: any,
    ): Promise<{ isValid: boolean; message?: string; discount?: number }> {
        const result = await this.couponService.validateCoupon(
            validateCouponDto.code,
            user.id,
            validateCouponDto.orderAmount,
            validateCouponDto.productIds,
            validateCouponDto.categoryIds,
        );

        return {
            isValid: result.isValid,
            message: result.message,
            discount: result.discount,
        };
    }

    @Get(':id')
    @HttpCode(HttpStatus.OK)
    @UseGuards(AuthGuard, RoleGuard)
    @Roles('ADMIN')
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å –∫—É–ø–æ–Ω –ø–æ ID (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)' })
    @ApiResponse({ status: 200, description: '–ö—É–ø–æ–Ω –ø–æ–ª—É—á–µ–Ω', type: CouponResponse })
    @ApiResponse({ status: 404, description: '–ö—É–ø–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω' })
    async getCouponById(@Param('id') id: number): Promise<CouponResponse> {
        const coupon = await this.couponService.findById(id);
        
        return {
            id: coupon.id,
            code: coupon.code,
            name: coupon.name,
            description: coupon.description,
            type: coupon.type,
            value: coupon.value,
            minOrderAmount: coupon.minOrderAmount,
            maxDiscount: coupon.maxDiscount,
            usageLimit: coupon.usageLimit,
            usageCount: coupon.usageCount,
            userLimit: coupon.userLimit,
            validFrom: coupon.validFrom,
            validTo: coupon.validTo,
            isActive: coupon.isActive,
            applicableProducts: coupon.applicableProducts,
            applicableCategories: coupon.applicableCategories,
            createdAt: coupon.createdAt,
            updatedAt: coupon.updatedAt,
        };
    }

    @Post()
    @HttpCode(HttpStatus.CREATED)
    @UseGuards(AuthGuard, RoleGuard)
    @Roles('ADMIN')
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫—É–ø–æ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)' })
    @ApiResponse({ status: 201, description: '–ö—É–ø–æ–Ω —Å–æ–∑–¥–∞–Ω', type: CouponResponse })
    @ApiResponse({ status: 400, description: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏' })
    async createCoupon(@Body() createCouponDto: CreateCouponDto): Promise<CouponResponse> {
        const coupon = await this.couponService.create(createCouponDto);
        
        return {
            id: coupon.id,
            code: coupon.code,
            name: coupon.name,
            description: coupon.description,
            type: coupon.type,
            value: coupon.value,
            minOrderAmount: coupon.minOrderAmount,
            maxDiscount: coupon.maxDiscount,
            usageLimit: coupon.usageLimit,
            usageCount: coupon.usageCount,
            userLimit: coupon.userLimit,
            validFrom: coupon.validFrom,
            validTo: coupon.validTo,
            isActive: coupon.isActive,
            applicableProducts: coupon.applicableProducts,
            applicableCategories: coupon.applicableCategories,
            createdAt: coupon.createdAt,
            updatedAt: coupon.updatedAt,
        };
    }

    @Put(':id')
    @HttpCode(HttpStatus.OK)
    @UseGuards(AuthGuard, RoleGuard)
    @Roles('ADMIN')
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–û–±–Ω–æ–≤–∏—Ç—å –∫—É–ø–æ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)' })
    @ApiResponse({ status: 200, description: '–ö—É–ø–æ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω', type: CouponResponse })
    @ApiResponse({ status: 404, description: '–ö—É–ø–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω' })
    @ApiResponse({ status: 400, description: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏' })
    async updateCoupon(
        @Param('id') id: number,
        @Body() updateCouponDto: UpdateCouponDto,
    ): Promise<CouponResponse> {
        const coupon = await this.couponService.update(id, updateCouponDto);
        
        return {
            id: coupon.id,
            code: coupon.code,
            name: coupon.name,
            description: coupon.description,
            type: coupon.type,
            value: coupon.value,
            minOrderAmount: coupon.minOrderAmount,
            maxDiscount: coupon.maxDiscount,
            usageLimit: coupon.usageLimit,
            usageCount: coupon.usageCount,
            userLimit: coupon.userLimit,
            validFrom: coupon.validFrom,
            validTo: coupon.validTo,
            isActive: coupon.isActive,
            applicableProducts: coupon.applicableProducts,
            applicableCategories: coupon.applicableCategories,
            createdAt: coupon.createdAt,
            updatedAt: coupon.updatedAt,
        };
    }

    @Delete(':id')
    @HttpCode(HttpStatus.NO_CONTENT)
    @UseGuards(AuthGuard, RoleGuard)
    @Roles('ADMIN')
    @ApiBearerAuth('JWT-auth')
    @ApiOperation({ summary: '–£–¥–∞–ª–∏—Ç—å –∫—É–ø–æ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)' })
    @ApiResponse({ status: 204, description: '–ö—É–ø–æ–Ω —É–¥–∞–ª–µ–Ω' })
    @ApiResponse({ status: 404, description: '–ö—É–ø–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω' })
    @ApiResponse({ status: 400, description: '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫—É–ø–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è' })
    async deleteCoupon(@Param('id') id: number): Promise<void> {
        return this.couponService.delete(id);
    }
}
```

## –ú–∏–≥—Ä–∞—Ü–∏–∏

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∫—É–ø–æ–Ω–æ–≤
```typescript
// db/migrations/YYYYMMDDHHMMSS-create-coupon-system.ts
import { QueryInterface, DataTypes } from 'sequelize';

export async function up(queryInterface: QueryInterface): Promise<void> {
    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã coupons
    await queryInterface.createTable('coupons', {
        id: {
            type: DataTypes.INTEGER,
            primaryKey: true,
            autoIncrement: true,
        },
        code: {
            type: DataTypes.STRING(50),
            allowNull: false,
            unique: true,
        },
        name: {
            type: DataTypes.STRING(100),
            allowNull: false,
        },
        description: {
            type: DataTypes.TEXT,
            allowNull: true,
        },
        type: {
            type: DataTypes.ENUM('percentage', 'fixed', 'free_shipping'),
            allowNull: false,
        },
        value: {
            type: DataTypes.DECIMAL(10, 2),
            allowNull: false,
        },
        min_order_amount: {
            type: DataTypes.DECIMAL(10, 2),
            allowNull: false,
            defaultValue: 0.00,
        },
        max_discount: {
            type: DataTypes.DECIMAL(10, 2),
            allowNull: true,
        },
        usage_limit: {
            type: DataTypes.INTEGER,
            allowNull: true,
        },
        usage_count: {
            type: DataTypes.INTEGER,
            allowNull: false,
            defaultValue: 0,
        },
        user_limit: {
            type: DataTypes.INTEGER,
            allowNull: false,
            defaultValue: 1,
        },
        valid_from: {
            type: DataTypes.DATE,
            allowNull: false,
        },
        valid_to: {
            type: DataTypes.DATE,
            allowNull: false,
        },
        is_active: {
            type: DataTypes.BOOLEAN,
            allowNull: false,
            defaultValue: true,
        },
        applicable_products: {
            type: DataTypes.ARRAY(DataTypes.INTEGER),
            allowNull: true,
        },
        applicable_categories: {
            type: DataTypes.ARRAY(DataTypes.INTEGER),
            allowNull: true,
        },
        created_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
        updated_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã coupon_usage
    await queryInterface.createTable('coupon_usage', {
        id: {
            type: DataTypes.INTEGER,
            primaryKey: true,
            autoIncrement: true,
        },
        coupon_id: {
            type: DataTypes.INTEGER,
            allowNull: false,
            references: { model: 'coupons', key: 'id' },
            onDelete: 'CASCADE',
        },
        user_id: {
            type: DataTypes.INTEGER,
            allowNull: false,
            references: { model: 'users', key: 'id' },
            onDelete: 'CASCADE',
        },
        order_id: {
            type: DataTypes.INTEGER,
            allowNull: false,
            references: { model: 'orders', key: 'id' },
            onDelete: 'CASCADE',
        },
        discount_amount: {
            type: DataTypes.DECIMAL(10, 2),
            allowNull: false,
        },
        used_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
    await queryInterface.addIndex('coupons', ['code'], { unique: true });
    await queryInterface.addIndex('coupons', ['type']);
    await queryInterface.addIndex('coupons', ['is_active']);
    await queryInterface.addIndex('coupons', ['valid_from', 'valid_to']);

    await queryInterface.addIndex('coupon_usage', ['coupon_id']);
    await queryInterface.addIndex('coupon_usage', ['user_id']);
    await queryInterface.addIndex('coupon_usage', ['order_id']);
    await queryInterface.addIndex('coupon_usage', ['used_at']);
}

export async function down(queryInterface: QueryInterface): Promise<void> {
    await queryInterface.dropTable('coupon_usage');
    await queryInterface.dropTable('coupons');
}
```

## DTO –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

### CreateCouponDto
```typescript
// src/infrastructure/dto/coupon/create-coupon.dto.ts
import { IsString, IsEnum, IsNumber, IsBoolean, IsOptional, IsArray, IsDateString, Length, Min, Max } from 'class-validator';
import { CouponType } from '@app/domain/models/coupon.model';

export class CreateCouponDto {
    @IsString({ message: '–ö–æ–¥ –∫—É–ø–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π' })
    @Length(3, 50, { message: '–ö–æ–¥ –∫—É–ø–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 3 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤' })
    declare readonly code: string;

    @IsString({ message: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É–ø–æ–Ω–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π' })
    @Length(1, 100, { message: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É–ø–æ–Ω–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤' })
    declare readonly name: string;

    @IsOptional()
    @IsString({ message: '–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π' })
    declare readonly description?: string;

    @IsEnum(CouponType, { message: '–¢–∏–ø –∫—É–ø–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: percentage, fixed, free_shipping' })
    declare readonly type: CouponType;

    @IsNumber({}, { message: '–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Min(0, { message: '–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º' })
    declare readonly value: number;

    @IsOptional()
    @IsNumber({}, { message: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Min(0, { message: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π' })
    declare readonly minOrderAmount?: number;

    @IsOptional()
    @IsNumber({}, { message: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Min(0, { message: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π' })
    declare readonly maxDiscount?: number;

    @IsOptional()
    @IsNumber({}, { message: '–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Min(1, { message: '–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0' })
    declare readonly usageLimit?: number;

    @IsOptional()
    @IsNumber({}, { message: '–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Min(1, { message: '–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0' })
    declare readonly userLimit?: number;

    @IsDateString({}, { message: '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π –¥–∞—Ç–æ–π' })
    declare readonly validFrom: string;

    @IsDateString({}, { message: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π –¥–∞—Ç–æ–π' })
    declare readonly validTo: string;

    @IsOptional()
    @IsBoolean({ message: '–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—É–ª–µ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º' })
    declare readonly isActive?: boolean;

    @IsOptional()
    @IsArray({ message: '–ü—Ä–∏–º–µ–Ω–∏–º—ã–µ —Ç–æ–≤–∞—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' })
    @IsNumber({}, { each: true, message: 'ID —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    declare readonly applicableProducts?: number[];

    @IsOptional()
    @IsArray({ message: '–ü—Ä–∏–º–µ–Ω–∏–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' })
    @IsNumber({}, { each: true, message: 'ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    declare readonly applicableCategories?: number[];
}
```

### UpdateCouponDto
```typescript
// src/infrastructure/dto/coupon/update-coupon.dto.ts
import { PartialType } from '@nestjs/swagger';
import { CreateCouponDto } from './create-coupon.dto';

export class UpdateCouponDto extends PartialType(CreateCouponDto) {}
```

### ValidateCouponDto
```typescript
// src/infrastructure/dto/coupon/validate-coupon.dto.ts
import { IsString, IsNumber, IsOptional, IsArray, Length, Min } from 'class-validator';

export class ValidateCouponDto {
    @IsString({ message: '–ö–æ–¥ –∫—É–ø–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π' })
    @Length(3, 50, { message: '–ö–æ–¥ –∫—É–ø–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 3 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤' })
    declare readonly code: string;

    @IsNumber({}, { message: '–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Min(0, { message: '–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π' })
    declare readonly orderAmount: number;

    @IsOptional()
    @IsArray({ message: 'ID —Ç–æ–≤–∞—Ä–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' })
    @IsNumber({}, { each: true, message: 'ID —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    declare readonly productIds?: number[];

    @IsOptional()
    @IsArray({ message: 'ID –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' })
    @IsNumber({}, { each: true, message: 'ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    declare readonly categoryIds?: number[];
}
```

## Response –∫–ª–∞—Å—Å—ã

### CouponResponse
```typescript
// src/infrastructure/responses/coupon/coupon.response.ts
import { ApiProperty } from '@nestjs/swagger';
import { CouponType } from '@app/domain/models/coupon.model';

export class CouponResponse {
    @ApiProperty({ description: 'ID –∫—É–ø–æ–Ω–∞' })
    declare readonly id: number;

    @ApiProperty({ description: '–ö–æ–¥ –∫—É–ø–æ–Ω–∞' })
    declare readonly code: string;

    @ApiProperty({ description: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É–ø–æ–Ω–∞' })
    declare readonly name: string;

    @ApiProperty({ description: '–û–ø–∏—Å–∞–Ω–∏–µ –∫—É–ø–æ–Ω–∞', required: false })
    declare readonly description?: string;

    @ApiProperty({ description: '–¢–∏–ø –∫—É–ø–æ–Ω–∞', enum: CouponType })
    declare readonly type: CouponType;

    @ApiProperty({ description: '–ó–Ω–∞—á–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏' })
    declare readonly value: number;

    @ApiProperty({ description: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞' })
    declare readonly minOrderAmount: number;

    @ApiProperty({ description: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞', required: false })
    declare readonly maxDiscount?: number;

    @ApiProperty({ description: '–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è', required: false })
    declare readonly usageLimit?: number;

    @ApiProperty({ description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π' })
    declare readonly usageCount: number;

    @ApiProperty({ description: '–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º' })
    declare readonly userLimit: number;

    @ApiProperty({ description: '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è' })
    declare readonly validFrom: Date;

    @ApiProperty({ description: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è' })
    declare readonly validTo: Date;

    @ApiProperty({ description: '–ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –∫—É–ø–æ–Ω' })
    declare readonly isActive: boolean;

    @ApiProperty({ description: '–ü—Ä–∏–º–µ–Ω–∏–º—ã–µ —Ç–æ–≤–∞—Ä—ã', required: false })
    declare readonly applicableProducts?: number[];

    @ApiProperty({ description: '–ü—Ä–∏–º–µ–Ω–∏–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', required: false })
    declare readonly applicableCategories?: number[];

    @ApiProperty({ description: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è' })
    declare readonly createdAt: Date;

    @ApiProperty({ description: '–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' })
    declare readonly updatedAt: Date;
}

export class CouponListResponse {
    @ApiProperty({ description: '–°–ø–∏—Å–æ–∫ –∫—É–ø–æ–Ω–æ–≤', type: [CouponResponse] })
    declare readonly data: CouponResponse[];

    @ApiProperty({ description: '–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏' })
    declare readonly meta: {
        totalCount: number;
        currentPage: number;
        limit: number;
        lastPage: number;
        nextPage: number | null;
        previousPage: number | null;
    };
}
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- [ ] –°–æ–∑–¥–∞–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü coupons –∏ coupon_usage
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–æ–¥–µ–ª–∏ Sequelize (CouponModel, CouponUsageModel)
- [ ] –°–æ–∑–¥–∞–Ω CouponService —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –∫—É–ø–æ–Ω–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω CouponController —Å API endpoints
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã DTO –∫–ª–∞—Å—Å—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- [ ] –°–æ–∑–¥–∞–Ω—ã Response –∫–ª–∞—Å—Å—ã —Å Swagger
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—É–ø–æ–Ω–æ–≤
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã unit —Ç–µ—Å—Ç—ã –¥–ª—è CouponService
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã integration —Ç–µ—Å—Ç—ã –¥–ª—è API
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –∑–∞–∫–∞–∑–æ–≤

### üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É–ø–æ–Ω–æ–≤
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–º–æ–∞–∫—Ü–∏–∏
- [ ] –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫—É–ø–æ–Ω–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å email –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–º

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (1 –Ω–µ–¥–µ–ª—è)
1. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è —Ç–∞–±–ª–∏—Ü coupons –∏ coupon_usage
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏** Sequelize
3. **–°–æ–∑–¥–∞—Ç—å DTO –∫–ª–∞—Å—Å—ã** —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
4. **–°–æ–∑–¥–∞—Ç—å Response –∫–ª–∞—Å—Å—ã** —Å Swagger
5. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CouponService** —Å –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–æ–π

### –§–∞–∑–∞ 2: API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (3-4 –¥–Ω—è)
6. **–°–æ–∑–¥–∞—Ç—å CouponController** —Å API endpoints
7. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∫—É–ø–æ–Ω–æ–≤** –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤
8. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –∫–æ—Ä–∑–∏–Ω–æ–π** –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–æ–∫
9. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏–º–∏—Ç–æ–≤** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –§–∞–∑–∞ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–∞—á–µ—Å—Ç–≤–æ (2-3 –¥–Ω—è)
10. **–ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã** –¥–ª—è CouponService
11. **–ù–∞–ø–∏—Å–∞—Ç—å integration —Ç–µ—Å—Ç—ã** –¥–ª—è API
12. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫** –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é
13. **–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥** –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é

## –†–∏—Å–∫–∏ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

### ‚ö†Ô∏è –†–∏—Å–∫–∏:
- **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏**: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å–∫–∏–¥–æ–∫
- **–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—É–ø–æ–Ω–æ–≤ –Ω–µ –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Redis –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—É–ø–æ–Ω–æ–≤
- **–í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã**: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏ –ø—Ä–æ–º–æ–∞–∫—Ü–∏–π
- **–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞**: —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –∫—É–ø–æ–Ω—ã –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

### üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã:
- **OrderService** - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫—É–ø–æ–Ω–æ–≤ –∫ –∑–∞–∫–∞–∑–∞–º
- **CartService** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—É–ø–æ–Ω–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ
- **UserService** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **ProductService** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º

### üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞:
- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫—É–ø–æ–Ω—ã
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–∫–∏–¥–æ–∫
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## TL;DR

–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫—É–ø–æ–Ω–æ–≤ –≤–∫–ª—é—á–∞–µ—Ç:
- **2 —Ç–∞–±–ª–∏—Ü—ã**: coupons, coupon_usage
- **2 –º–æ–¥–µ–ª–∏**: CouponModel, CouponUsageModel
- **1 —Å–µ—Ä–≤–∏—Å**: CouponService —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
- **1 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä**: API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—É–ø–æ–Ω–∞–º–∏
- **–§—É–Ω–∫—Ü–∏–∏**: –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ/—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∫–∏–¥–∫–∏, –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –ª–∏–º–∏—Ç–∞–º, —Ç–æ–≤–∞—Ä–∞–º, –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å**: –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º
```