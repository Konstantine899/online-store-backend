# –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä–∑–∏–Ω—ã (Cart System) - Ecommerce Edition

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ü–µ–ª—å
–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è ecommerce –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –±—ã—Å—Ç—Ä—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É, –ø—Ä–æ—Å—Ç–æ—Ç—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- **–ì–æ—Å—Ç–µ–≤—ã–µ –∫–æ—Ä–∑–∏–Ω—ã** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
- **–ü—Ä–æ–º–æ–∫–æ–¥—ã** - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –±–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `carts`
```sql
CREATE TABLE carts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    session_id VARCHAR(255),
    status VARCHAR(20) DEFAULT 'active',
    subtotal DECIMAL(10,2) DEFAULT 0.00,
    discount_amount DECIMAL(10,2) DEFAULT 0.00,
    total DECIMAL(10,2) DEFAULT 0.00,
    ip_address VARCHAR(45),
    is_abandoned BOOLEAN DEFAULT false,
    is_guest_cart BOOLEAN DEFAULT false,
    is_saved BOOLEAN DEFAULT false,
    is_shared BOOLEAN DEFAULT false,
    is_wishlist BOOLEAN DEFAULT false,
    is_template BOOLEAN DEFAULT false,
    is_public BOOLEAN DEFAULT false,
    is_locked BOOLEAN DEFAULT false,
    is_archived BOOLEAN DEFAULT false,
    is_recovered BOOLEAN DEFAULT false,
    is_converted BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP
);
```

### –¢–∞–±–ª–∏—Ü–∞ `cart_items`
```sql
CREATE TABLE cart_items (
    id SERIAL PRIMARY KEY,
    cart_id INTEGER REFERENCES carts(id) ON DELETE CASCADE,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL DEFAULT 1,
    price DECIMAL(10,2) NOT NULL,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(cart_id, product_id)
);
```

## –ú–æ–¥–µ–ª–∏ Sequelize

### Cart Model
```typescript
// src/domain/models/cart.model.ts
import { Model, DataType, Column, Table, BelongsTo, HasMany, ForeignKey } from 'sequelize-typescript';
import { Op } from 'sequelize';
import { UserModel } from './user.model';
import { CartItemModel } from './cart-item.model';

@Table({
    tableName: 'carts',
    underscored: true,
    timestamps: true,
    indexes: [
        { fields: ['user_id'], name: 'idx_carts_user_id' },
        { fields: ['session_id'], name: 'idx_carts_session_id' },
        { fields: ['status'], name: 'idx_carts_status' },
        { fields: ['expires_at'], name: 'idx_carts_expires_at' },
        { fields: ['is_abandoned'], name: 'idx_carts_is_abandoned' },
        { fields: ['is_guest_cart'], name: 'idx_carts_is_guest_cart' },
        { fields: ['is_saved'], name: 'idx_carts_is_saved' },
        { fields: ['is_shared'], name: 'idx_carts_is_shared' },
        { fields: ['is_wishlist'], name: 'idx_carts_is_wishlist' },
        { fields: ['is_template'], name: 'idx_carts_is_template' },
        { fields: ['is_public'], name: 'idx_carts_is_public' },
        { fields: ['is_locked'], name: 'idx_carts_is_locked' },
        { fields: ['is_archived'], name: 'idx_carts_is_archived' },
        { fields: ['is_recovered'], name: 'idx_carts_is_recovered' },
        { fields: ['is_converted'], name: 'idx_carts_is_converted' },
        { fields: ['is_abandoned', 'is_guest_cart'], name: 'idx_carts_abandoned_guest' },
        { fields: ['user_id', 'is_abandoned'], name: 'idx_carts_user_abandoned' },
    ],
})
export class CartModel extends Model<CartModel, ICartCreationAttributes> {
    @Column({
        type: DataType.INTEGER,
        primaryKey: true,
        autoIncrement: true,
    })
    declare id: number;

    @ForeignKey(() => UserModel)
    @Column({
        type: DataType.INTEGER,
        allowNull: true,
        field: 'user_id',
    })
    declare userId: number;

    @Column({
        type: DataType.STRING(255),
        allowNull: true,
        field: 'session_id',
    })
    declare sessionId: string;

    @Column({
        type: DataType.STRING(20),
        allowNull: false,
        defaultValue: 'active',
    })
    declare status: string;

    @Column({
        type: DataType.DECIMAL(10, 2),
        allowNull: false,
        defaultValue: 0.00,
    })
    declare subtotal: number;

    @Column({
        type: DataType.DECIMAL(10, 2),
        allowNull: false,
        defaultValue: 0.00,
        field: 'discount_amount',
    })
    declare discountAmount: number;

    @Column({
        type: DataType.DECIMAL(10, 2),
        allowNull: false,
        defaultValue: 0.00,
    })
    declare total: number;

    @Column({
        type: DataType.STRING(45),
        allowNull: true,
        field: 'ip_address',
    })
    declare ipAddress: string;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_abandoned',
    })
    declare isAbandoned: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_guest_cart',
    })
    declare isGuestCart: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_saved',
    })
    declare isSaved: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_shared',
    })
    declare isShared: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_wishlist',
    })
    declare isWishlist: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_template',
    })
    declare isTemplate: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_public',
    })
    declare isPublic: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_locked',
    })
    declare isLocked: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_archived',
    })
    declare isArchived: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_recovered',
    })
    declare isRecovered: boolean;

    @Column({
        type: DataType.BOOLEAN,
        allowNull: false,
        defaultValue: false,
        field: 'is_converted',
    })
    declare isConverted: boolean;

    @Column({
        type: DataType.DATE,
        allowNull: true,
        field: 'expires_at',
    })
    declare expiresAt: Date;

    @BelongsTo(() => UserModel)
    declare user: UserModel;

    @HasMany(() => CartItemModel)
    declare items: CartItemModel[];

    // Getters –¥–ª—è —Ñ–ª–∞–≥–æ–≤
    get isAbandonedCart(): boolean {
        return this.isAbandoned;
    }

    get isGuestCart(): boolean {
        return this.isGuestCart;
    }

    get isSavedCart(): boolean {
        return this.isSaved;
    }

    get isSharedCart(): boolean {
        return this.isShared;
    }

    get isWishlistCart(): boolean {
        return this.isWishlist;
    }

    get isTemplateCart(): boolean {
        return this.isTemplate;
    }

    get isPublicCart(): boolean {
        return this.isPublic;
    }

    get isLockedCart(): boolean {
        return this.isLocked;
    }

    get isArchivedCart(): boolean {
        return this.isArchived;
    }

    get isRecoveredCart(): boolean {
        return this.isRecovered;
    }

    get isConvertedCart(): boolean {
        return this.isConverted;
    }

    get cartType(): string {
        if (this.isWishlist) return 'wishlist';
        if (this.isTemplate) return 'template';
        if (this.isPublic) return 'public';
        if (this.isShared) return 'shared';
        if (this.isSaved) return 'saved';
        if (this.isAbandoned) return 'abandoned';
        if (this.isGuestCart) return 'guest';
        if (this.isArchived) return 'archived';
        return 'active';
    }

    get isRegisteredUserCart(): boolean {
        return !this.isGuestCart && this.userId !== null;
    }

    get canBeRecovered(): boolean {
        return this.isAbandoned && this.items && this.items.length > 0;
    }

    get needsCleanup(): boolean {
        return this.isAbandoned && this.expiresAt && new Date() > this.expiresAt;
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–ª–∞–≥–∞–º–∏
    async markAsAbandoned(): Promise<void> {
        await this.update({ isAbandoned: true });
    }

    async markAsActive(): Promise<void> {
        await this.update({ isAbandoned: false });
    }

    async markAsGuestCart(): Promise<void> {
        await this.update({ isGuestCart: true, userId: null });
    }

    async markAsUserCart(userId: number): Promise<void> {
        await this.update({ isGuestCart: false, userId });
    }

    async markAsSaved(): Promise<void> {
        await this.update({ isSaved: true });
    }

    async unmarkAsSaved(): Promise<void> {
        await this.update({ isSaved: false });
    }

    async markAsShared(): Promise<void> {
        await this.update({ isShared: true });
    }

    async unmarkAsShared(): Promise<void> {
        await this.update({ isShared: false });
    }

    async markAsWishlist(): Promise<void> {
        await this.update({ isWishlist: true });
    }

    async unmarkAsWishlist(): Promise<void> {
        await this.update({ isWishlist: false });
    }

    async markAsTemplate(): Promise<void> {
        await this.update({ isTemplate: true });
    }

    async unmarkAsTemplate(): Promise<void> {
        await this.update({ isTemplate: false });
    }

    async markAsPublic(): Promise<void> {
        await this.update({ isPublic: true });
    }

    async unmarkAsPublic(): Promise<void> {
        await this.update({ isPublic: false });
    }

    async lockCart(): Promise<void> {
        await this.update({ isLocked: true });
    }

    async unlockCart(): Promise<void> {
        await this.update({ isLocked: false });
    }

    async archiveCart(): Promise<void> {
        await this.update({ isArchived: true });
    }

    async unarchiveCart(): Promise<void> {
        await this.update({ isArchived: false });
    }

    async markAsRecovered(): Promise<void> {
        await this.update({ isRecovered: true, isAbandoned: false });
    }

    async unmarkAsRecovered(): Promise<void> {
        await this.update({ isRecovered: false });
    }

    async markAsConverted(): Promise<void> {
        await this.update({ isConverted: true });
    }

    async unmarkAsConverted(): Promise<void> {
        await this.update({ isConverted: false });
    }

    // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–ª–∞–≥–∞–º–∏
    static async getAbandonedCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isAbandoned: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getGuestCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isGuestCart: true },
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getCartsForRecovery(): Promise<CartModel[]> {
        return this.findAll({
            where: { 
                isAbandoned: true,
                expiresAt: { [Op.gt]: new Date() }
            },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getSavedCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isSaved: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getSharedCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isShared: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getWishlistCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isWishlist: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getTemplateCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isTemplate: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getPublicCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isPublic: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getLockedCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isLocked: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getUnlockedCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isLocked: false },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getArchivedCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isArchived: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getNonArchivedCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isArchived: false },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getRecoveredCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isRecovered: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getNonRecoveredCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isRecovered: false },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getConvertedCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isConverted: true },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }

    static async getNonConvertedCarts(): Promise<CartModel[]> {
        return this.findAll({
            where: { isConverted: false },
            include: [{ association: 'items' }],
            order: [['updatedAt', 'DESC']],
        });
    }
}
```

## –°–µ—Ä–≤–∏—Å—ã

### Cart Service
```typescript
// src/infrastructure/services/cart.service.ts
import { Injectable, Logger, BadRequestException, NotFoundException } from '@nestjs/common';
import { InjectModel } from '@nestjs/sequelize';
import { Op } from 'sequelize';
import { CartModel } from '@app/domain/models/cart.model';
import { CartItemModel } from '@app/domain/models/cart-item.model';
import { ProductModel } from '@app/domain/models/product.model';

@Injectable()
export class CartService {
    private readonly logger = new Logger(CartService.name);

    constructor(
        @InjectModel(CartModel)
        private cartModel: typeof CartModel,
        @InjectModel(CartItemModel)
        private cartItemModel: typeof CartItemModel,
        @InjectModel(ProductModel)
        private productModel: typeof ProductModel,
    ) {}

    async getOrCreateCart(
        userId?: number,
        sessionId?: string,
        ipAddress?: string,
    ): Promise<CartModel> {
        let cart: CartModel;

        if (userId) {
            cart = await this.cartModel.findOne({
                where: { userId, status: 'active' },
                include: ['items'],
            });
        } else if (sessionId) {
            cart = await this.cartModel.findOne({
                where: { sessionId, status: 'active' },
                include: ['items'],
            });
        }

        if (!cart) {
            cart = await this.cartModel.create({
                userId,
                sessionId,
                ipAddress,
                expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 –¥–Ω–µ–π
            });
        }

        return cart;
    }

    async addToCart(
        cartId: number,
        productId: number,
        quantity: number = 1,
    ): Promise<CartItemModel> {
        const cart = await this.cartModel.findByPk(cartId);
        if (!cart) {
            throw new NotFoundException('–ö–æ—Ä–∑–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        }

        const product = await this.productModel.findByPk(productId);
        if (!product || !product.isActive) {
            throw new NotFoundException('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω');
        }

        if (product.stock < quantity) {
            throw new BadRequestException('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ');
        }

        const existingItem = await this.cartItemModel.findOne({
            where: { cartId, productId },
        });

        if (existingItem) {
            await existingItem.update({
                quantity: existingItem.quantity + quantity,
            });
        } else {
            await this.cartItemModel.create({
                cartId,
                productId,
                quantity,
                price: product.price,
            });
        }

        await this.recalculateCart(cartId);
        return existingItem || await this.cartItemModel.findOne({
            where: { cartId, productId },
        });
    }

    async updateCartItem(
        cartId: number,
        productId: number,
        quantity: number,
    ): Promise<CartItemModel> {
        const item = await this.cartItemModel.findOne({
            where: { cartId, productId },
        });

        if (!item) {
            throw new NotFoundException('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω–µ');
        }

        if (quantity <= 0) {
            await this.removeFromCart(cartId, productId);
            return null;
        }

        await item.update({ quantity });
        await this.recalculateCart(cartId);
        return item;
    }

    async removeFromCart(cartId: number, productId: number): Promise<void> {
        const deletedCount = await this.cartItemModel.destroy({
            where: { cartId, productId },
        });

        if (deletedCount === 0) {
            throw new NotFoundException('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω–µ');
        }

        await this.recalculateCart(cartId);
    }

    async applyCoupon(cartId: number, couponCode: string): Promise<boolean> {
        const cart = await this.cartModel.findByPk(cartId, {
            include: ['items'],
        });

        if (!cart) {
            throw new NotFoundException('–ö–æ—Ä–∑–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        }

        // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
        const coupon = await this.validateCoupon(couponCode, cart.subtotal);
        if (!coupon) {
            return false;
        }

        const discountAmount = this.calculateDiscount(coupon, cart.subtotal);
        await cart.update({
            discountAmount: cart.discountAmount + discountAmount,
        });

        await this.recalculateCart(cartId);
        return true;
    }

    private async recalculateCart(cartId: number): Promise<void> {
        const cart = await this.cartModel.findByPk(cartId, {
            include: ['items'],
        });

        if (!cart) return;

        const subtotal = cart.items.reduce((sum, item) => 
            sum + (item.price * item.quantity), 0
        );

        const total = subtotal - cart.discountAmount;

        await cart.update({ subtotal, total });
    }

    private async validateCoupon(code: string, subtotal: number): Promise<any> {
        // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è - –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —á–µ—Ä–µ–∑ CouponService
        return { code, discountType: 'percentage', discountValue: 10, minimumAmount: 100 };
    }

    private calculateDiscount(coupon: any, subtotal: number): number {
        if (coupon.discountType === 'percentage') {
            return (subtotal * coupon.discountValue) / 100;
        }
        return coupon.discountValue;
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–ª–∞–≥–∞–º–∏ –∫–æ—Ä–∑–∏–Ω
    async markCartAsAbandoned(cartId: number): Promise<CartModel> {
        const cart = await this.getCartById(cartId);
        await cart.markAsAbandoned();
        return cart;
    }

    async markCartAsActive(cartId: number): Promise<CartModel> {
        const cart = await this.getCartById(cartId);
        await cart.markAsActive();
        return cart;
    }

    async markCartAsGuest(cartId: number): Promise<CartModel> {
        const cart = await this.getCartById(cartId);
        await cart.markAsGuestCart();
        return cart;
    }

    async markCartAsUser(cartId: number, userId: number): Promise<CartModel> {
        const cart = await this.getCartById(cartId);
        await cart.markAsUserCart(userId);
        return cart;
    }

    async markCartAsSaved(cartId: number): Promise<CartModel> {
        const cart = await this.getCartById(cartId);
        await cart.markAsSaved();
        this.logger.log(`–ö–æ—Ä–∑–∏–Ω–∞ ${cartId} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`);
        return cart;
    }

    async unmarkCartAsSaved(cartId: number): Promise<CartModel> {
        const cart = await this.getCartById(cartId);
        await cart.unmarkAsSaved();
        this.logger.log(`–ö–æ—Ä–∑–∏–Ω–∞ ${cartId} –±–æ–ª—å—à–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`);
        return cart;
    }

    async markCartAsShared(cartId: number): Promise<CartModel> {
        const cart = await this.getCartById(cartId);
        await cart.markAsShared();
        this.logger.log(`–ö–æ—Ä–∑–∏–Ω–∞ ${cartId} —Ä–∞—Å—à–∞—Ä–µ–Ω–∞`);
        return cart;
    }

    async unmarkCartAsShared(cartId: number): Promise<CartModel> {
        const cart = await this.getCartById(cartId);
        await cart.unmarkAsShared();
        this.logger.log(`–ö–æ—Ä–∑–∏–Ω–∞ ${cartId} –±–æ–ª—å—à–µ –Ω–µ —Ä–∞—Å—à–∞—Ä–µ–Ω–∞`);
        return cart;
    }

    async getAbandonedCarts(): Promise<CartModel[]> {
        return this.cartModel.getAbandonedCarts();
    }

    async getGuestCarts(): Promise<CartModel[]> {
        return this.cartModel.getGuestCarts();
    }

    async getCartsForRecovery(): Promise<CartModel[]> {
        return this.cartModel.getCartsForRecovery();
    }

    async getSavedCarts(): Promise<CartModel[]> {
        return this.cartModel.getSavedCarts();
    }

    async getSharedCarts(): Promise<CartModel[]> {
        return this.cartModel.getSharedCarts();
    }

    async getCartStatistics(): Promise<{
        totalCarts: number;
        activeCarts: number;
        abandonedCarts: number;
        guestCarts: number;
        userCarts: number;
        recoverableCarts: number;
    }> {
        const [
            totalCarts,
            activeCarts,
            abandonedCarts,
            guestCarts,
            userCarts,
            recoverableCarts,
            savedCarts,
            sharedCarts,
        ] = await Promise.all([
            this.cartModel.count(),
            this.cartModel.count({ where: { status: 'active', isAbandoned: false } }),
            this.cartModel.count({ where: { isAbandoned: true } }),
            this.cartModel.count({ where: { isGuestCart: true } }),
            this.cartModel.count({ where: { isGuestCart: false, userId: { [Op.ne]: null } } }),
            this.cartModel.count({ 
                where: { 
                    isAbandoned: true,
                    expiresAt: { [Op.gt]: new Date() }
                }
            }),
            this.cartModel.count({ where: { isSaved: true } }),
            this.cartModel.count({ where: { isShared: true } }),
        ]);

        return {
            totalCarts,
            activeCarts,
            abandonedCarts,
            guestCarts,
            userCarts,
            recoverableCarts,
            savedCarts,
            sharedCarts,
        };
    }
}
```

## –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã

### Cart Controller
```typescript
// src/infrastructure/controllers/cart.controller.ts
import { Controller, Get, Post, Put, Delete, Patch, Param, Body, Query, HttpCode, HttpStatus, ParseIntPipe, Req } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';
import { CartService } from '@app/infrastructure/services/cart.service';
import { AddToCartDto } from '@app/infrastructure/dto/cart/add-to-cart.dto';
import { UpdateCartItemDto } from '@app/infrastructure/dto/cart/update-cart-item.dto';

@ApiTags('–ö–æ—Ä–∑–∏–Ω–∞')
@Controller('cart')
export class CartController {
    constructor(private readonly cartService: CartService) {}

    @Get()
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É' })
    async getCart(
        @Query('userId') userId: number,
        @Query('sessionId') sessionId: string,
        @Req() req: any,
    ) {
        const cart = await this.cartService.getOrCreateCart(
            userId,
            sessionId,
            req.ip,
        );

        return {
            data: cart,
            meta: {
                itemCount: cart.items?.length || 0,
                totalValue: cart.total,
            },
        };
    }

    @Post('items')
    @HttpCode(HttpStatus.CREATED)
    @ApiOperation({ summary: '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É' })
    async addToCart(
        @Body() addToCartDto: AddToCartDto,
        @Query('userId') userId: number,
        @Query('sessionId') sessionId: string,
        @Req() req: any,
    ) {
        const cart = await this.cartService.getOrCreateCart(
            userId,
            sessionId,
            req.ip,
        );

        return this.cartService.addToCart(
            cart.id,
            addToCartDto.productId,
            addToCartDto.quantity,
        );
    }

    @Put('items/:productId')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞' })
    async updateCartItem(
        @Param('productId') productId: number,
        @Body() updateCartItemDto: UpdateCartItemDto,
        @Query('userId') userId: number,
        @Query('sessionId') sessionId: string,
        @Req() req: any,
    ) {
        const cart = await this.cartService.getOrCreateCart(
            userId,
            sessionId,
            req.ip,
        );

        return this.cartService.updateCartItem(
            cart.id,
            productId,
            updateCartItemDto.quantity,
        );
    }

    @Delete('items/:productId')
    @HttpCode(HttpStatus.NO_CONTENT)
    @ApiOperation({ summary: '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã' })
    async removeFromCart(
        @Param('productId') productId: number,
        @Query('userId') userId: number,
        @Query('sessionId') sessionId: string,
        @Req() req: any,
    ) {
        const cart = await this.cartService.getOrCreateCart(
            userId,
            sessionId,
            req.ip,
        );

        return this.cartService.removeFromCart(cart.id, productId);
    }

    @Post('coupon')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥' })
    async applyCoupon(
        @Body() body: { couponCode: string },
        @Query('userId') userId: number,
        @Query('sessionId') sessionId: string,
        @Req() req: any,
    ) {
        const cart = await this.cartService.getOrCreateCart(
            userId,
            sessionId,
            req.ip,
        );

        const success = await this.cartService.applyCoupon(
            cart.id,
            body.couponCode,
        );

        return {
            success,
            message: success ? '–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω' : '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω',
        };
    }

    // API endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–ª–∞–≥–∞–º–∏ –∫–æ—Ä–∑–∏–Ω
    @Patch(':id/abandoned')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–û—Ç–º–µ—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∫–∞–∫ –±—Ä–æ—à–µ–Ω–Ω—É—é' })
    @ApiResponse({ status: 200, description: '–ö–æ—Ä–∑–∏–Ω–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –±—Ä–æ—à–µ–Ω–Ω–∞—è' })
    async markAsAbandoned(@Param('id', ParseIntPipe) id: number): Promise<CartModel> {
        return this.cartService.markCartAsAbandoned(id);
    }

    @Patch(':id/active')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–û—Ç–º–µ—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é' })
    @ApiResponse({ status: 200, description: '–ö–æ—Ä–∑–∏–Ω–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–∞—è' })
    async markAsActive(@Param('id', ParseIntPipe) id: number): Promise<CartModel> {
        return this.cartService.markCartAsActive(id);
    }

    @Patch(':id/guest')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–û—Ç–º–µ—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∫–∞–∫ –≥–æ—Å—Ç–µ–≤—É—é' })
    @ApiResponse({ status: 200, description: '–ö–æ—Ä–∑–∏–Ω–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≥–æ—Å—Ç–µ–≤–∞—è' })
    async markAsGuest(@Param('id', ParseIntPipe) id: number): Promise<CartModel> {
        return this.cartService.markCartAsGuest(id);
    }

    @Patch(':id/user/:userId')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é' })
    @ApiResponse({ status: 200, description: '–ö–æ—Ä–∑–∏–Ω–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é' })
    async markAsUser(
        @Param('id', ParseIntPipe) id: number,
        @Param('userId', ParseIntPipe) userId: number,
    ): Promise<CartModel> {
        return this.cartService.markCartAsUser(id, userId);
    }

    @Get('abandoned')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω' })
    @ApiResponse({ status: 200, description: '–°–ø–∏—Å–æ–∫ –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω' })
    async getAbandonedCarts(): Promise<CartModel[]> {
        return this.cartService.getAbandonedCarts();
    }

    @Get('guest')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–≤—ã—Ö –∫–æ—Ä–∑–∏–Ω' })
    @ApiResponse({ status: 200, description: '–°–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–≤—ã—Ö –∫–æ—Ä–∑–∏–Ω' })
    async getGuestCarts(): Promise<CartModel[]> {
        return this.cartService.getGuestCarts();
    }

    @Get('saved')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω' })
    @ApiResponse({ status: 200, description: '–°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω' })
    async getSavedCarts(): Promise<CartModel[]> {
        return this.cartService.getSavedCarts();
    }

    @Get('shared')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω' })
    @ApiResponse({ status: 200, description: '–°–ø–∏—Å–æ–∫ —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω' })
    async getSharedCarts(): Promise<CartModel[]> {
        return this.cartService.getSharedCarts();
    }

    @Patch(':id/saved')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É' })
    @ApiResponse({ status: 200, description: '–ö–æ—Ä–∑–∏–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞' })
    async markAsSaved(@Param('id', ParseIntPipe) id: number): Promise<CartModel> {
        return this.cartService.markCartAsSaved(id);
    }

    @Patch(':id/unsaved')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–£–±—Ä–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö' })
    @ApiResponse({ status: 200, description: '–ö–æ—Ä–∑–∏–Ω–∞ —É–±—Ä–∞–Ω–∞ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö' })
    async unmarkAsSaved(@Param('id', ParseIntPipe) id: number): Promise<CartModel> {
        return this.cartService.unmarkCartAsSaved(id);
    }

    @Patch(':id/shared')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–†–∞—Å—à–∞—Ä–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É' })
    @ApiResponse({ status: 200, description: '–ö–æ—Ä–∑–∏–Ω–∞ —Ä–∞—Å—à–∞—Ä–µ–Ω–∞' })
    async markAsShared(@Param('id', ParseIntPipe) id: number): Promise<CartModel> {
        return this.cartService.markCartAsShared(id);
    }

    @Patch(':id/unshared')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–£–±—Ä–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∏–∑ —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω—ã—Ö' })
    @ApiResponse({ status: 200, description: '–ö–æ—Ä–∑–∏–Ω–∞ —É–±—Ä–∞–Ω–∞ –∏–∑ —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω—ã—Ö' })
    async unmarkAsShared(@Param('id', ParseIntPipe) id: number): Promise<CartModel> {
        return this.cartService.unmarkCartAsShared(id);
    }

    @Get('recovery')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è' })
    @ApiResponse({ status: 200, description: '–°–ø–∏—Å–æ–∫ –∫–æ—Ä–∑–∏–Ω –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è' })
    async getCartsForRecovery(): Promise<CartModel[]> {
        return this.cartService.getCartsForRecovery();
    }

    @Get('statistics')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: '–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ—Ä–∑–∏–Ω' })
    @ApiResponse({ status: 200, description: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω' })
    async getCartStatistics(): Promise<{
        totalCarts: number;
        activeCarts: number;
        abandonedCarts: number;
        guestCarts: number;
        userCarts: number;
        recoverableCarts: number;
    }> {
        return this.cartService.getCartStatistics();
    }
}
```

## DTO –∫–ª–∞—Å—Å—ã

### AddToCartDto
```typescript
// src/infrastructure/dto/cart/add-to-cart.dto.ts
import { IsInt, Min, Max } from 'class-validator';
import { Type } from 'class-transformer';

export class AddToCartDto {
    @IsInt({ message: 'ID —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Type(() => Number)
    declare readonly productId: number;

    @IsInt({ message: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Min(1, { message: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0' })
    @Max(999, { message: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 999' })
    @Type(() => Number)
    declare readonly quantity: number;
}
```

### UpdateCartItemDto
```typescript
// src/infrastructure/dto/cart/update-cart-item.dto.ts
import { IsInt, Min, Max } from 'class-validator';
import { Type } from 'class-transformer';

export class UpdateCartItemDto {
    @IsInt({ message: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º' })
    @Min(1, { message: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0' })
    @Max(999, { message: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 999' })
    @Type(() => Number)
    declare readonly quantity: number;
}
```

## –ú–∏–≥—Ä–∞—Ü–∏–∏

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
```typescript
// db/migrations/YYYYMMDDHHMMSS-create-cart-system.ts
import { QueryInterface, DataTypes } from 'sequelize';

export async function up(queryInterface: QueryInterface): Promise<void> {
    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã carts
    await queryInterface.createTable('carts', {
        id: {
            type: DataTypes.INTEGER,
            primaryKey: true,
            autoIncrement: true,
        },
        user_id: {
            type: DataTypes.INTEGER,
            allowNull: true,
            references: { model: 'users', key: 'id' },
            onDelete: 'CASCADE',
        },
        session_id: {
            type: DataTypes.STRING(255),
            allowNull: true,
        },
        status: {
            type: DataTypes.STRING(20),
            allowNull: false,
            defaultValue: 'active',
        },
        subtotal: {
            type: DataTypes.DECIMAL(10, 2),
            allowNull: false,
            defaultValue: 0.00,
        },
        discount_amount: {
            type: DataTypes.DECIMAL(10, 2),
            allowNull: false,
            defaultValue: 0.00,
        },
        total: {
            type: DataTypes.DECIMAL(10, 2),
            allowNull: false,
            defaultValue: 0.00,
        },
        ip_address: {
            type: DataTypes.STRING(45),
            allowNull: true,
        },
        created_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
        updated_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
        expires_at: {
            type: DataTypes.DATE,
            allowNull: true,
        },
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã cart_items
    await queryInterface.createTable('cart_items', {
        id: {
            type: DataTypes.INTEGER,
            primaryKey: true,
            autoIncrement: true,
        },
        cart_id: {
            type: DataTypes.INTEGER,
            allowNull: false,
            references: { model: 'carts', key: 'id' },
            onDelete: 'CASCADE',
        },
        product_id: {
            type: DataTypes.INTEGER,
            allowNull: false,
            references: { model: 'products', key: 'id' },
            onDelete: 'CASCADE',
        },
        quantity: {
            type: DataTypes.INTEGER,
            allowNull: false,
            defaultValue: 1,
        },
        price: {
            type: DataTypes.DECIMAL(10, 2),
            allowNull: false,
        },
        added_at: {
            type: DataTypes.DATE,
            allowNull: false,
            defaultValue: DataTypes.NOW,
        },
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
    await queryInterface.addIndex('carts', ['user_id']);
    await queryInterface.addIndex('carts', ['session_id']);
    await queryInterface.addIndex('carts', ['status']);
    await queryInterface.addIndex('carts', ['expires_at']);
    await queryInterface.addIndex('cart_items', ['cart_id']);
    await queryInterface.addIndex('cart_items', ['product_id']);
    await queryInterface.addIndex('cart_items', ['cart_id', 'product_id'], { unique: true });
}

export async function down(queryInterface: QueryInterface): Promise<void> {
    await queryInterface.dropTable('cart_items');
    await queryInterface.dropTable('carts');
}
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- [ ] –°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã carts –∏ cart_items —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–æ–¥–µ–ª–∏ CartModel –∏ CartItemModel
- [ ] –°–æ–∑–¥–∞–Ω CartService —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω CartController —Å API endpoints
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã DTO –∫–ª–∞—Å—Å—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- [ ] –°–æ–∑–¥–∞–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ë–î
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ—Å—Ç–µ–≤—ã—Ö —Å–µ—Å—Å–∏–π
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç —Å—É–º–º
- [ ] –ë–∞–∑–æ–≤–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

### üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω (Redis)
- [ ] Rate limiting –¥–ª—è API
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω–∞—Ö
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- [ ] –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (1 –Ω–µ–¥–µ–ª—è)
1. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è —Ç–∞–±–ª–∏—Ü carts –∏ cart_items
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏** CartModel –∏ CartItemModel
3. **–°–æ–∑–¥–∞—Ç—å CartService** —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
4. **–î–æ–±–∞–≤–∏—Ç—å DTO –∫–ª–∞—Å—Å—ã** —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

### –§–∞–∑–∞ 2: API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (1 –Ω–µ–¥–µ–ª—è)
5. **–°–æ–∑–¥–∞—Ç—å CartController** —Å API endpoints
6. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏** (–±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)
7. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫** –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é
8. **–ù–∞–ø–∏—Å–∞—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã**

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (1 –Ω–µ–¥–µ–ª—è)
9. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –∫–æ—Ä–∑–∏–Ω
10. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å rate limiting**
11. **–î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É** –∫–æ—Ä–∑–∏–Ω—ã
12. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

## –ù–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –∫–æ—Ä–∑–∏–Ω

### –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤:
- **isAbandoned** - –ë—Ä–æ—à–µ–Ω–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –ø–æ–∫—É–ø–∫—É)
- **isGuestCart** - –ì–æ—Å—Ç–µ–≤–∞—è –∫–æ—Ä–∑–∏–Ω–∞ (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ñ–ª–∞–≥–æ–≤:
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω
- **Email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥** - —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è** - –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–∫—É–ø–æ–∫ –≥–æ—Å—Ç–µ–π vs –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≥–æ—Å—Ç–µ–≤—ã—Ö –∫–æ—Ä–∑–∏–Ω
- **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** - —Ä–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≥–æ—Å—Ç–µ–π –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã:
- **API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–ª–∞–≥–∞–º–∏** - PATCH endpoints –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω** - GET endpoints –ø–æ —Ç–∏–ø–∞–º –∫–æ—Ä–∑–∏–Ω
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω** - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ñ–ª–∞–≥–∞–º
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** - –≤—ã—è–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö –∫–æ—Ä–∑–∏–Ω

## TL;DR

–ü—Ä–∞–∫—Ç–∏—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä–∑–∏–Ω—ã –≤–∫–ª—é—á–∞–µ—Ç:
- **2 —Ç–∞–±–ª–∏—Ü—ã**: carts, cart_items
- **2 –º–æ–¥–µ–ª–∏**: Cart, CartItem —Å —Ñ–ª–∞–≥–∞–º–∏ isAbandoned, isGuestCart
- **1 —Å–µ—Ä–≤–∏—Å**: CartService —Å –º–µ—Ç–æ–¥–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–ª–∞–≥–∞–º–∏
- **1 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä**: API –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã —Å endpoints –¥–ª—è —Ñ–ª–∞–≥–æ–≤
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞**: –≥–æ—Å—Ç–µ–≤—ã–µ —Å–µ—Å—Å–∏–∏, –ø—Ä–æ–º–æ–∫–æ–¥—ã, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω
- **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: 2-3 –Ω–µ–¥–µ–ª–∏
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å**: –∫ –±—ã—Å—Ç—Ä–æ–º—É –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω