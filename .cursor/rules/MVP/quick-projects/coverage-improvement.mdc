# Coverage Improvement: –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏ –ø–æ–¥—Ö–æ–¥

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ–∫—É—â–∏–π test coverage: **47%**

- Functions: 47%
- Lines: 50%
- Statements: 50%
- Branches: 45%

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–¥—É–ª–∏ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 85%+):**

- Auth: ~60% ‚ö†Ô∏è
- Guards: ~55% ‚ö†Ô∏è
- Security: ~40% ‚ùå

**–ü—Ä–æ–±–ª–µ–º–∞ –¥–ª—è Middle:**

- –ù–∏–∑–∫–∏–π coverage = –ø–ª–æ—Ö–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ
- –ù–µ—Ç comprehensive —Ç–µ—Å—Ç–æ–≤ = –Ω–µ–¥–æ–≤–µ—Ä–∏–µ
- Middle –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å testing strategies

**–¶–µ–ª—å:** 75%+ global, 85%+ critical modules

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤

### –ß—Ç–æ –ø–æ–∫—Ä—ã—Ç–æ:

- ‚úÖ –ë–∞–∑–æ–≤—ã–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ (60-70%)
- ‚úÖ Happy path —Å—Ü–µ–Ω–∞—Ä–∏–∏
- ‚úÖ –ù–µ–∫–æ—Ç–æ—Ä—ã–µ integration —Ç–µ—Å—Ç—ã

### –ß—Ç–æ –ù–ï –ø–æ–∫—Ä—ã—Ç–æ:

- ‚ùå Edge cases (–≥—Ä–∞–Ω–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è)
- ‚ùå Failure scenarios (—á—Ç–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
- ‚ùå Security scenarios (XSS, rate limiting)
- ‚ùå RBAC comprehensive (–≤—Å–µ —Ä–æ–ª–∏/permissions)
- ‚ùå Race conditions
- ‚ùå Concurrent operations

**–ò—Ç–æ–≥–æ: –Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤!**

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è —É–ª—É—á—à–µ–Ω–∏—è

### Test Pyramid (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)

```
        /\
       /  \  E2E (5 tests)
      /‚îÄ‚îÄ‚îÄ‚îÄ\
     /      \  Integration (185+ tests)
    /‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\
   /          \  Unit (150+ tests)
  /‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\
```

**–ù–∞—à–∞ —Ü–µ–ª—å:**

- Unit: ~150 —Ç–µ—Å—Ç–æ–≤ (–±—ã—Å—Ç—Ä—ã–µ, –º–æ–∫–∏)
- Integration: ~185 —Ç–µ—Å—Ç–æ–≤ (—Ä–µ–∞–ª—å–Ω–∞—è –ë–î)
- E2E: ~5 —Ç–µ—Å—Ç–æ–≤ (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ flows)

### Coverage Targets (production-grade)

| –ú–æ–¥—É–ª—å           | –¢–µ–∫—É—â–∏–π | –¶–µ–ª—å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
| ---------------- | ------- | ---- | --------- |
| **Auth**         | 60%     | 85%+ | –ö–†–ò–¢–ò–ß–ù–û  |
| **Guards**       | 55%     | 85%+ | –ö–†–ò–¢–ò–ß–ù–û  |
| **Services**     | 50%     | 75%+ | –í–´–°–û–ö–ò–ô   |
| **Controllers**  | 45%     | 70%+ | –°–†–ï–î–ù–ò–ô   |
| **Repositories** | 40%     | 65%+ | –°–†–ï–î–ù–ò–ô   |

**Focus: –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–¥—É–ª–∏ —Å–Ω–∞—á–∞–ª–∞!**

---

## üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è

### 1. Comprehensive Auth Tests (+30 —Ç–µ—Å—Ç–æ–≤)

**–ü–æ–∫—Ä—ã–≤–∞–µ–º:**

- Registration flow (success + validation)
- Login flow (success + failures)
- Refresh token flow (rotation + errors)
- Password reset flow (full cycle)
- Logout flow (invalidation)

**–¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤:**

- ‚úÖ Success paths (happy flow)
- ‚ùå Validation errors (400)
- ‚ùå Auth errors (401)
- ‚ùå Permission errors (403)
- ‚è±Ô∏è Rate limiting (429)

### 2. Security Tests (+27 —Ç–µ—Å—Ç–æ–≤)

**Brute Force Protection:**

- Login rate limiting
- Refresh rate limiting
- Registration rate limiting
- 429 responses —Å Retry-After

**Input Validation:**

- XSS prevention
- SQL injection prevention
- Validation pipes comprehensive

### 3. RBAC Tests (+20 —Ç–µ—Å—Ç–æ–≤)

**Role Hierarchy:**

- SUPER_ADMIN ‚Üí ADMIN ‚Üí USER ‚Üí GUEST
- Permissions –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è

**Permission Matrix:**

- –ö–∞–∂–¥–∞—è —Ä–æ–ª—å √ó –∫—Ä–∏—Ç–∏—á–Ω—ã–µ endpoints
- 403 –¥–ª—è forbidden actions
- Tenant isolation

### 4. Coverage Configuration

**jest.config.js:**

- Global thresholds
- Per-module thresholds
- Exclude DTO/responses

**CI Integration:**

- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ merge –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ coverage
- Coverage reports upload
- Badge –≤ README

---

## üéì Middle vs Junior Testing

### Junior –ø–æ–¥—Ö–æ–¥:

- "–ù–∞–ø–∏—Å–∞–ª –ø–∞—Ä—É —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π"
- Coverage ~30-50%
- –¢–æ–ª—å–∫–æ happy paths
- –ú–æ–∫–∏ "–≥–¥–µ-—Ç–æ —Ç–∞–º"

### Middle –ø–æ–¥—Ö–æ–¥ (—Ç–≤–æ–π):

- **Comprehensive coverage:** 75%+ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ 85%+
- **Test pyramid:** –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ unit/integration
- **Negative scenarios:** –≤—Å–µ failure cases –ø–æ–∫—Ä—ã—Ç—ã
- **Security testing:** XSS, SQL injection, rate limiting
- **RBAC matrix:** –≤—Å–µ —Ä–æ–ª–∏ –∏ permissions –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- **CI/CD integration:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ coverage

**–≠—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä—å—ë–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ quality!**

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ —É–ª—É—á—à–µ–Ω–∏—è:

- Total tests: 335
- Coverage: 47% global
- Auth module: 60%
- Guards: 55%
- Negative tests: ~20%

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏—è:

- Total tests: 412+ (+77)
- Coverage: 75%+ global
- Auth module: 85%+
- Guards: 85%+
- Negative tests: 50%+

**Improvement:**

- +77 —Ç–µ—Å—Ç–æ–≤
- +28% coverage
- +25% –¥–ª—è critical modules

---

## üìã –†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –∑–∞–¥–∞—á–∏ (High-Level)

### –ó–∞–¥–∞—á–∞ 1: PROD-020 - Comprehensive Auth Tests

**–ü—Ä–æ–±–ª–µ–º–∞:** Auth module coverage —Ç–æ–ª—å–∫–æ 60%

**–ü–æ–¥–∑–∞–¥–∞—á–∏:**

1. Registration success tests (+6 —Ç–µ—Å—Ç–æ–≤)
2. Registration validation tests (+8 —Ç–µ—Å—Ç–æ–≤)
3. Login flow tests (+10 —Ç–µ—Å—Ç–æ–≤)
4. Refresh token flow tests (+8 —Ç–µ—Å—Ç–æ–≤)
5. Password reset flow tests (+6 —Ç–µ—Å—Ç–æ–≤)
6. Logout flow tests (+4 —Ç–µ—Å—Ç–æ–≤)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** +42 auth —Ç–µ—Å—Ç–∞, coverage ‚â•85%

**–û—Ü–µ–Ω–∫–∞:** 16-20 —á–∞—Å–æ–≤

---

### –ó–∞–¥–∞—á–∞ 2: PROD-021 - Security Tests

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è rate limiting –∏ XSS prevention

**–ü–æ–¥–∑–∞–¥–∞—á–∏:**

1. Brute force protection tests (+6 —Ç–µ—Å—Ç–æ–≤)
2. Rate limiting tests –¥–ª—è refresh/registration (+6 —Ç–µ—Å—Ç–æ–≤)
3. XSS prevention tests (+8 —Ç–µ—Å—Ç–æ–≤)
4. SQL injection tests (+6 —Ç–µ—Å—Ç–æ–≤)
5. Validation pipes tests (+6 —Ç–µ—Å—Ç–æ–≤)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** +32 security —Ç–µ—Å—Ç–∞

**–û—Ü–µ–Ω–∫–∞:** 10-12 —á–∞—Å–æ–≤

---

### –ó–∞–¥–∞—á–∞ 3: PROD-022 - RBAC Tests

**–ü—Ä–æ–±–ª–µ–º–∞:** Guards coverage —Ç–æ–ª—å–∫–æ 55%, –Ω–µ—Ç permission matrix

**–ü–æ–¥–∑–∞–¥–∞—á–∏:**

1. Role hierarchy tests (+6 —Ç–µ—Å—Ç–æ–≤)
2. Permission matrix tests (+10 —Ç–µ—Å—Ç–æ–≤)
3. Tenant isolation tests (+6 —Ç–µ—Å—Ç–æ–≤)
4. Role assignment restrictions (+4 —Ç–µ—Å—Ç–∞)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** +26 RBAC —Ç–µ—Å—Ç–æ–≤, Guards ‚â•85%

**–û—Ü–µ–Ω–∫–∞:** 14-18 —á–∞—Å–æ–≤

---

### –ó–∞–¥–∞—á–∞ 4: PROD-023 - Coverage Configuration

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç thresholds, CI –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç coverage

**–ü–æ–¥–∑–∞–¥–∞—á–∏:**

1. Configure per-module thresholds –≤ jest.config
2. CI coverage check
3. Coverage reports –∏ badges
4. Update testing documentation

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** CI –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏ –Ω–∏–∑–∫–æ–º coverage

**–û—Ü–µ–Ω–∫–∞:** 3-4 —á–∞—Å–∞

---

## üîß Testing Utilities

### –î–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞—ë–º:

**TestDataFactory** (—É–∂–µ –µ—Å—Ç—å –∏–∑ Testing Fixes):

- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–∏–ª–¥–µ—Ä—ã

**TestCleanup** (—É–∂–µ –µ—Å—Ç—å):

- –ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ cleanup

**AuthTestHelpers:**

- `authLoginAs(role)` - –±—ã—Å—Ç—Ä—ã–π –ª–æ–≥–∏–Ω
- `createAuthHeaders(token)` - headers –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
- `expectUnauthorized()` - –ø—Ä–æ–≤–µ—Ä–∫–∏ 401

**AssertionHelpers:**

- `expectPaginatedResponse()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ { data, meta }
- `expectValidationError()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ 400 —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- `expectRateLimitError()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ 429

---

## üéØ –¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤

### Unit Tests (–±—ã—Å—Ç—Ä—ã–µ, –º–Ω–æ–≥–æ)

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**

- –°–µ—Ä–≤–∏—Å—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ (–º–æ–∫–∏ –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤)
- Guards logic (–º–æ–∫–∏ –¥–ª—è requests)
- Pipes transformation (–º–æ–∫–∏ –¥–ª—è metadata)
- Utilities (—á–∏—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**

- –ë—ã—Å—Ç—Ä—ã–µ (<1ms –∫–∞–∂–¥—ã–π)
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–Ω–µ—Ç –ë–î/—Å–µ—Ç–∏)
- –ú–Ω–æ–≥–æ (60-70% –æ—Ç –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤)

### Integration Tests (—Ä–µ–∞–ª—å–Ω–∞—è –ë–î)

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**

- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —á–µ—Ä–µ–∑ HTTP
- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
- Auth flow end-to-end
- –í–∞–ª–∏–¥–∞—Ü–∏—è DTO

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**

- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ (~50-200ms)
- –†–µ–∞–ª—å–Ω–∞—è –ë–î (–º–∏–≥—Ä–∞—Ü–∏–∏ + seeds)
- –ú–µ–Ω—å—à–µ unit (30-40% –æ—Ç –≤—Å–µ—Ö)

### E2E Tests (—Ä–µ–¥–∫–∏–µ, –∫—Ä–∏—Ç–∏—á–Ω—ã–µ)

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**

- –ü–æ–ª–Ω—ã–µ user journeys
- Registration ‚Üí Login ‚Üí Shopping ‚Üí Checkout
- Admin user management flow

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**

- –°–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ (~1-5s)
- –ú–∏–Ω–∏–º—É–º –º–æ–∫–æ–≤
- –û—á–µ–Ω—å –º–∞–ª–æ (~5 —Ç–µ—Å—Ç–æ–≤)

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ:

- [ ] Total tests ‚â• 412
- [ ] Global coverage ‚â• 75%
- [ ] Auth coverage ‚â• 85%
- [ ] Guards coverage ‚â• 85%
- [ ] 100% pass rate

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ:

- [ ] –í—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã
- [ ] Negative scenarios comprehensive
- [ ] Security tests –≤–∫–ª—é—á–µ–Ω—ã
- [ ] RBAC matrix –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞
- [ ] CI integration —Ä–∞–±–æ—Ç–∞–µ—Ç

### –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ:

- [ ] –¢–µ—Å—Ç—ã –±—ã—Å—Ç—Ä—ã–µ (<30s total)
- [ ] –ù–µ—Ç flaky tests
- [ ] Deterministic results
- [ ] CI –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏

---

## üöÄ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–î–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ:**

- "75%+ test coverage —Å comprehensive strategy"
- "85%+ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (auth, security)"
- "412+ —Ç–µ—Å—Ç–æ–≤ –≤–∫–ª—é—á–∞—è negative scenarios –∏ edge cases"

**–î–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–π:**

- –ú–æ–∂–µ—à—å –æ–±—ä—è—Å–Ω–∏—Ç—å testing strategy
- –ú–æ–∂–µ—à—å –ø–æ–∫–∞–∑–∞—Ç—å comprehensive coverage
- –ú–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ Test Pyramid
- –ü–æ–Ω–∏–º–∞–µ—à—å trade-offs (unit vs integration)

**–≠—Ç–æ strong Middle –Ω–∞–≤—ã–∫!**

**–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω:** —Å–º. [coverage-improvement.plan.mdc](./coverage-improvement.plan.mdc)
