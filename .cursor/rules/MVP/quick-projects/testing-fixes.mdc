# Testing Fixes: –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏ –ø–æ–¥—Ö–æ–¥

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤:

- ‚ùå Race conditions –≤ user-admin —Ç–µ—Å—Ç–∞—Ö
- ‚ùå 500 errors –≤ user-profile —Ç–µ—Å—Ç–∞—Ö
- ‚ùå FK constraint errors –≤ address —Ç–µ—Å—Ç–∞—Ö
- ‚ùå Undefined role –≤ rbac —Ç–µ—Å—Ç–∞—Ö
- ‚ùå SQL logging –∑–∞–≥—Ä—è–∑–Ω—è–µ—Ç –≤—ã–≤–æ–¥
- ‚ùå –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –í–´–°–û–ö–ê–Ø (–±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É)

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω

### 1. Race Conditions

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ email/phone

- –î–≤–∞ —Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞—é—Ç `test@example.com` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- Unique constraint violation
- –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º

**–†–µ—à–µ–Ω–∏–µ:** –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞

### 2. Database Pollution

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç cleanup –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

- –î–∞–Ω–Ω—ã–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è
- FK constraints –Ω–∞—Ä—É—à–∞—é—Ç—Å—è
- –¢–µ—Å—Ç—ã –≤–ª–∏—è—é—Ç –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞

**–†–µ—à–µ–Ω–∏–µ:** Cleanup –≤ afterEach hooks

### 3. Async Issues

**–ü—Ä–∏—á–∏–Ω–∞:** LoginHistoryService async –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

- Uncaught promise rejections
- 500 errors –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**–†–µ—à–µ–Ω–∏–µ:** Proper async/await + error handling

### 4. Seed Dependencies

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–µ—Å—Ç—ã –æ–∂–∏–¥–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–æ–ª–∏

- Seeds –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã
- undefined role parameter

**–†–µ—à–µ–Ω–∏–µ:** Verify seeds –≤ beforeAll

### 5. Noise –≤ –≤—ã–≤–æ–¥–µ

**–ü—Ä–∏—á–∏–Ω–∞:** SQL logging –≤–∫–ª—é—á–µ–Ω –≤ —Ç–µ—Å—Ç–∞—Ö

- –¢—Ä—É–¥–Ω–æ —á–∏—Ç–∞—Ç—å test results
- –ó–∞—Ö–ª–∞–º–ª—ë–Ω–Ω—ã–π –≤—ã–≤–æ–¥

**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–∫–ª—é—á–∏—Ç—å SQL logging –≤ test env

---

## üéØ –¶–µ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:**

- ‚úÖ 0 failed tests –∏–∑ 335+
- ‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç 10 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
- ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ
- ‚úÖ –ù–µ—Ç race conditions

**–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:**

- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (email, phone)
- ‚úÖ Cleanup –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

**–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å:**

- ‚úÖ –ß–∏—Å—Ç—ã–π –≤—ã–≤–æ–¥ (–±–µ–∑ SQL)
- ‚úÖ –¢–æ–ª—å–∫–æ test results
- ‚úÖ –û—à–∏–±–∫–∏ –ø–æ–Ω—è—Ç–Ω—ã

**Maintainability:**

- ‚úÖ Test utilities (–Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚úÖ TestDataFactory
- ‚úÖ TestCleanup

---

## üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è

### 1. TestDataFactory

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ú–µ—Ç–æ–¥—ã:**

- `uniqueEmail()` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π email –¥–ª—è —Ç–µ—Å—Ç–∞
- `uniquePhone()` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω
- `createUser(overrides)` - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞
- `createProduct(overrides)` - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- –ì–∞—Ä–∞–Ω—Ç–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
- –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å

### 2. TestCleanup

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ë–î –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

**–ú–µ—Ç–æ–¥—ã:**

- `cleanUsers()` - –æ—á–∏—Å—Ç–∏—Ç—å users + —Å–≤—è–∑–∏ (addresses, roles, history)
- `cleanOrders()` - –æ—á–∏—Å—Ç–∏—Ç—å orders + order_items
- `cleanCart()` - –æ—á–∏—Å—Ç–∏—Ç—å cart + cart_products
- `cleanAll()` - –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (FK dependencies)
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤

### 3. Configuration

**test.env:**

- `SQL_LOGGING=false` - –±–µ–∑ SQL –≤ –≤—ã–≤–æ–¥–µ
- `LOG_LEVEL=error` - —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏

**test-app.module.ts:**

- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å logging –≤ Sequelize
- Silent mode –¥–ª—è —Ç–µ—Å—Ç–æ–≤

---

## üìã –†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –∑–∞–¥–∞—á–∏ (High-Level)

### –ó–∞–¥–∞—á–∞ 1: PROD-001 - –ò—Å–ø—Ä–∞–≤–∏—Ç—å race conditions

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ email/phone, –ø–∞–¥–∞—é—Ç –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ

**–ü–æ–¥–∑–∞–¥–∞—á–∏:**

1. –î–æ–±–∞–≤–∏—Ç—å cleanup –¥–ª—è user_role –≤ afterEach
2. –î–æ–±–∞–≤–∏—Ç—å cleanup –¥–ª—è user_address –≤ afterEach
3. –°–æ–∑–¥–∞—Ç—å TestDataFactory —Å uniqueEmail
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å uniqueEmail –≤ —Ç–µ—Å—Ç–∞—Ö
5. –î–æ–±–∞–≤–∏—Ç—å uniquePhone –≤ TestDataFactory
6. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å uniquePhone –≤ —Ç–µ—Å—Ç–∞—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –±–µ–∑ race conditions

**–û—Ü–µ–Ω–∫–∞:** 3-4 —á–∞—Å–∞

---

### –ó–∞–¥–∞—á–∞ 2: PROD-002 - –ò—Å–ø—Ä–∞–≤–∏—Ç—å 500 errors

**–ü—Ä–æ–±–ª–µ–º–∞:** LoginHistoryService –≤—ã–∑—ã–≤–∞–µ—Ç 500 –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ –≤ —Ç–µ—Å—Ç–∞—Ö

**–ü–æ–¥–∑–∞–¥–∞—á–∏:**

1. –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ authLoginAs
2. –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É LoginHistoryService
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å async –ø—Ä–æ–±–ª–µ–º—É –≤ LoginHistoryService
4. –î–æ–±–∞–≤–∏—Ç—å cleanup –¥–ª—è login_history

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç–∞–±–∏–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω –±–µ–∑ 500 errors

**–û—Ü–µ–Ω–∫–∞:** 2-3 —á–∞—Å–∞

---

### –ó–∞–¥–∞—á–∞ 3: PROD-003 - –ò—Å–ø—Ä–∞–≤–∏—Ç—å addresses –∏ rbac

**–ü—Ä–æ–±–ª–µ–º–∞:** FK constraint errors –∏ undefined roles

**–ü–æ–¥–∑–∞–¥–∞—á–∏:**

1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å FK constraint –≤ address —Ç–µ—Å—Ç–∞—Ö
2. –î–æ–±–∞–≤–∏—Ç—å cleanup addresses
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å undefined role –≤ rbac
4. –î–æ–±–∞–≤–∏—Ç—å cleanup refresh_token

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Address –∏ RBAC —Ç–µ—Å—Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω—ã

**–û—Ü–µ–Ω–∫–∞:** 3-4 —á–∞—Å–∞

---

### –ó–∞–¥–∞—á–∞ 4: PROD-004 - Test Utilities

**–ü—Ä–æ–±–ª–µ–º–∞:** –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ cleanup –∫–æ–¥–∞, SQL noise –≤ –≤—ã–≤–æ–¥–µ

**–ü–æ–¥–∑–∞–¥–∞—á–∏:**

1. –°–æ–∑–¥–∞—Ç—å TestCleanup utility
2. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TestCleanup
3. –û—Ç–∫–ª—é—á–∏—Ç—å SQL logging –≤ —Ç–µ—Å—Ç–∞—Ö
4. –î–æ–±–∞–≤–∏—Ç—å LOG_LEVEL=error –≤ .test.env

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** DRY –∫–æ–¥, —á–∏—Å—Ç—ã–π –≤—ã–≤–æ–¥ —Ç–µ—Å—Ç–æ–≤

**–û—Ü–µ–Ω–∫–∞:** 3-4 —á–∞—Å–∞

---

## üîß –ü–æ–¥—Ö–æ–¥ –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–Ω—Ü–∏–ø: –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ù–µ –¥–µ–ª–∞–µ–º:** –û–¥–∏–Ω –±–æ–ª—å—à–æ–π fix
**–î–µ–ª–∞–µ–º:** –°–µ—Ä–∏—é –º–∞–ª–µ–Ω—å–∫–∏—Ö –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –∑–∞–¥–∞—á

**–ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞:**

- –û–¥–∏–Ω –∞—Å–ø–µ–∫—Ç –ø—Ä–æ–±–ª–µ–º—ã
- –û–¥–∏–Ω –∫–æ–º–º–∏—Ç
- –ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- 10-60 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã

### –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!

1. **–°–Ω–∞—á–∞–ª–∞ cleanup** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
2. **–ó–∞—Ç–µ–º unique data** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç conflicts
3. **–ü–æ—Ç–æ–º async fixes** - –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏–∫—É
4. **–í –∫–æ–Ω—Ü–µ utilities** - —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏ DRY

–ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å —Å utilities, –ø–æ–∫–∞ –Ω–µ –ø–æ–Ω–∏–º–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–æ–±–ª–µ–º!

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:

- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ (0 failed)
- [ ] –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å 10 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ (stable)
- [ ] –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ (deterministic)
- [ ] Cleanup —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] TestDataFactory –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ:

- [ ] –ß–∏—Å—Ç—ã–π –≤—ã–≤–æ–¥ (–±–µ–∑ SQL noise)
- [ ] –ë—ã—Å—Ç—Ä–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–Ω–µ –∑–∞–º–µ–¥–ª–∏–ª–∏—Å—å)
- [ ] –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã (utilities –≥–æ—Ç–æ–≤—ã)

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:

- [ ] –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è cleanup logic
- [ ] DRY –ø—Ä–∏–Ω—Ü–∏–ø —Å–æ–±–ª—é–¥—ë–Ω
- [ ] Utilities –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

- Failed tests: ~15-20 –∏–∑ 335
- SQL logging: 1000+ —Å—Ç—Ä–æ–∫ –≤ –≤—ã–≤–æ–¥–µ
- –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: 50% (–ø–∞–¥–∞—é—Ç —á–µ—Ä–µ–∑ —Ä–∞–∑)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ cleanup: 10+ –º–µ—Å—Ç

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

- Failed tests: 0 –∏–∑ 335
- SQL logging: 0 —Å—Ç—Ä–æ–∫
- –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: 100%
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ cleanup: 0 (–≤—Å–µ —á–µ—Ä–µ–∑ utilities)

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Testing Fixes:**

- –ë–∞–∑–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ –Ω–∞–¥—ë–∂–Ω–∞
- –ú–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã
- Coverage improvement –Ω–µ –±—É–¥–µ—Ç —Ñ–ª–µ–π–∫–∞—Ç—å
- –ü–µ—Ä–µ—Ö–æ–¥ –∫ Security Hardening

**–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω:** —Å–º. [testing-fixes.plan.mdc](./testing-fixes.plan.mdc)
